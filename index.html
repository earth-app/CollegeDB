<!DOCTYPE html><html class="default" lang="en" data-base="./"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@earth-app/collegedb</title><meta name="description" content="Documentation for @earth-app/collegedb"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="index.html" class="title">@earth-app/collegedb</a><div id="tsd-toolbar-links"></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h1>@earth-app/collegedb</h1></div><div class="tsd-panel tsd-typography"><h1 id="collegedb" class="tsd-anchor-link">CollegeDB<a href="#collegedb" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h1><blockquote>
<p>Cloudflare D1 Horizontal Sharding Router</p>
</blockquote>
<p><a href="https://www.typescriptlang.org/"><img src="https://img.shields.io/badge/TypeScript-5.0+-blue.svg" alt="TypeScript"></a>
<a href="https://github.com/earth-app/CollegeDB/issues"><img src="https://img.shields.io/github/issues/earth-app/CollegeDB" alt="GitHub Issues"></a>
<a href="https://workers.cloudflare.com/"><img src="https://img.shields.io/badge/cloudflare-workers-orange.svg" alt="Cloudflare Workers"></a>
<a href="LICENSE"><img src="https://img.shields.io/github/license/earth-app/CollegeDB" alt="GitHub License"></a>
<img src="https://img.shields.io/npm/v/%40earth-app%2Fcollegedb" alt="NPM Version"></p>
<p>A TypeScript library for <strong>true horizontal scaling</strong> of SQLite-style databases on Cloudflare using D1 and KV. CollegeDB distributes your data across multiple D1 databases, with each table's records split by primary key across different database instances.</p>
<p>CollegeDB implements <strong>data distribution</strong> where a single logical table is physically stored across multiple D1 databases:</p>
<pre><code class="txt">env.db-east (Shard 1)
┌────────────────────────────────────────────┐
│ table users: [user-1, user-3, user-5, ...] │
│ table posts: [post-2, post-7, post-9, ...] │
└────────────────────────────────────────────┘

env.db-west (Shard 2)
┌────────────────────────────────────────────┐
│ table users: [user-2, user-4, user-6, ...] │
│ table posts: [post-1, post-3, post-8, ...] │
└────────────────────────────────────────────┘

env.db-central (Shard 3)
┌────────────────────────────────────────────┐
│ table users: [user-7, user-8, user-9, ...] │
│ table posts: [post-4, post-5, post-6, ...] │
└────────────────────────────────────────────┘
</code><button type="button">Copy</button></pre>

<p>This allows you to:</p>
<ul>
<li><strong>Break through D1's single database limits</strong> by spreading data across many databases</li>
<li><strong>Improve query performance</strong> by reducing data per database instance</li>
<li><strong>Scale geographically</strong> by placing shards in different regions</li>
<li><strong>Increase write throughput</strong> by parallelizing across multiple database instances</li>
</ul>
<h2 id="📈-overview" class="tsd-anchor-link">📈 Overview<a href="#📈-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>CollegeDB provides a sharding layer on top of Cloudflare D1 databases, enabling you to:</p>
<ul>
<li><strong>Scale horizontally</strong> by distributing table data across multiple D1 instances</li>
<li><strong>Route queries automatically</strong> based on primary key mappings</li>
<li><strong>Maintain consistency</strong> with KV-based shard mapping</li>
<li><strong>Optimize for geography</strong> with location-aware shard allocation</li>
<li><strong>Monitor and rebalance</strong> shard distribution</li>
<li><strong>Handle migrations</strong> between shards seamlessly</li>
</ul>
<h2 id="📦-features" class="tsd-anchor-link">📦 Features<a href="#📦-features" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li><strong>🔀 Automatic Query Routing</strong>: Primary key → shard mapping using Cloudflare KV</li>
<li><strong>🎯 Multiple Allocation Strategies</strong>: Round-robin, random, hash-based, and location-aware distribution</li>
<li><strong>🔄 Mixed Strategy Support</strong>: Different strategies for reads vs writes (e.g., location for writes, hash for reads)</li>
<li><strong>📊 Shard Coordination</strong>: Durable Objects for allocation and statistics</li>
<li><strong>🛠 Migration Support</strong>: Move data between shards with zero downtime</li>
<li><strong>🔄 Automatic Drop-in Replacement</strong>: Zero-config integration with existing databases</li>
<li><strong>🤖 Smart Migration Detection</strong>: Automatically discovers and maps existing data</li>
<li><strong>⚡ High Performance</strong>: Optimized for Cloudflare Workers runtime</li>
<li><strong>🔧 TypeScript First</strong>: Full type safety and excellent DX</li>
</ul>
<h2 id="installation" class="tsd-anchor-link">Installation<a href="#installation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="bash"><span class="hl-0">bun</span><span class="hl-1"> </span><span class="hl-2">add</span><span class="hl-1"> </span><span class="hl-2">collegedb</span><br/><span class="hl-3"># or</span><br/><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">install</span><span class="hl-1"> </span><span class="hl-2">collegedb</span>
</code><button type="button">Copy</button></pre>

<h2 id="basic-usage" class="tsd-anchor-link">Basic Usage<a href="#basic-usage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="typescript"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">collegedb</span><span class="hl-1">, </span><span class="hl-5">createSchema</span><span class="hl-1">, </span><span class="hl-5">run</span><span class="hl-1">, </span><span class="hl-5">first</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Initialize with your Cloudflare bindings (existing databases work automatically!)</span><br/><span class="hl-0">collegedb</span><span class="hl-1">(</span><br/><span class="hl-1">	{</span><br/><span class="hl-1">		</span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">coordinator:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">shards:</span><span class="hl-1"> {</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">[</span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-1">], </span><span class="hl-3">// Can be existing DB with data</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">[</span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-1">] </span><span class="hl-3">// Can be existing DB with data</span><br/><span class="hl-1">		},</span><br/><span class="hl-1">		</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;hash&#39;</span><br/><span class="hl-1">	},</span><br/><span class="hl-1">	</span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-3">// Create schema on new shards only (existing shards auto-detected)</span><br/><span class="hl-1">		</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">createSchema</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">[</span><span class="hl-2">&#39;db-new-shard&#39;</span><span class="hl-1">]);</span><br/><br/><span class="hl-1">		</span><span class="hl-3">// Insert data (automatically routed to appropriate shard)</span><br/><span class="hl-1">		</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">run</span><span class="hl-1">(</span><span class="hl-2">&#39;user-123&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;INSERT INTO users (id, name, email) VALUES (?, ?, ?)&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;user-123&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;Johnson&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;alice@example.com&#39;</span><span class="hl-1">]);</span><br/><br/><span class="hl-1">		</span><span class="hl-3">// Query data (automatically routed to correct shard, works with existing data!)</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">result</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">first</span><span class="hl-1">&lt;</span><span class="hl-8">User</span><span class="hl-1">&gt;(</span><span class="hl-2">&#39;existing-user-456&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;SELECT * FROM users WHERE id = ?&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;existing-user-456&#39;</span><span class="hl-1">]);</span><br/><br/><span class="hl-1">		</span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-5">result</span><span class="hl-1">); </span><span class="hl-3">// User data from existing database</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h3 id="geographic-distribution-example" class="tsd-anchor-link">Geographic Distribution Example<a href="#geographic-distribution-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">collegedb</span><span class="hl-1">, </span><span class="hl-5">first</span><span class="hl-1">, </span><span class="hl-5">run</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Optimize for North American users with geographic sharding</span><br/><span class="hl-0">collegedb</span><span class="hl-1">(</span><br/><span class="hl-1">	{</span><br/><span class="hl-1">		</span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;location&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">targetRegion:</span><span class="hl-1"> </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">, </span><span class="hl-3">// Western North America</span><br/><span class="hl-1">		</span><span class="hl-5">shardLocations:</span><span class="hl-1"> {</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-5">:</span><span class="hl-1"> { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">2</span><span class="hl-1"> }, </span><span class="hl-3">// SF - Preferred for target region</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-5">:</span><span class="hl-1"> { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;enam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">1</span><span class="hl-1"> }, </span><span class="hl-3">// NYC - Secondary</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-europe&#39;</span><span class="hl-5">:</span><span class="hl-1"> { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;weur&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">0.5</span><span class="hl-1"> } </span><span class="hl-3">// London - Fallback</span><br/><span class="hl-1">		},</span><br/><span class="hl-1">		</span><span class="hl-5">shards:</span><span class="hl-1"> {</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_WEST</span><span class="hl-1">,</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_EAST</span><span class="hl-1">,</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-europe&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_EUROPE</span><br/><span class="hl-1">		}</span><br/><span class="hl-1">	},</span><br/><span class="hl-1">	</span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-3">// New users will be allocated to db-west (closest to target region)</span><br/><span class="hl-1">		</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">run</span><span class="hl-1">(</span><span class="hl-2">&#39;user-west-123&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;INSERT INTO users (id, name, location) VALUES (?, ?, ?)&#39;</span><span class="hl-1">, [</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;user-west-123&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;West Coast User&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;California&#39;</span><br/><span class="hl-1">		]);</span><br/><br/><span class="hl-1">		</span><span class="hl-3">// Queries are routed to the correct geographic shard</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">user</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">first</span><span class="hl-1">&lt;</span><span class="hl-8">User</span><span class="hl-1">&gt;(</span><span class="hl-2">&#39;user-west-123&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;SELECT * FROM users WHERE id = ?&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;user-west-123&#39;</span><span class="hl-1">]);</span><br/><span class="hl-1">		</span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`User found in optimal shard: </span><span class="hl-7">${</span><span class="hl-5">user</span><span class="hl-10">?.</span><span class="hl-5">name</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h3 id="mixed-strategy-example" class="tsd-anchor-link">Mixed Strategy Example<a href="#mixed-strategy-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">collegedb</span><span class="hl-1">, </span><span class="hl-5">first</span><span class="hl-1">, </span><span class="hl-5">run</span><span class="hl-1">, </span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-5">MixedShardingStrategy</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Use location strategy for writes (optimal data placement) and hash for reads (optimal performance)</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">mixedStrategy</span><span class="hl-1">: </span><span class="hl-8">MixedShardingStrategy</span><span class="hl-1"> = {</span><br/><span class="hl-1">	</span><span class="hl-5">write:</span><span class="hl-1"> </span><span class="hl-2">&#39;location&#39;</span><span class="hl-1">, </span><span class="hl-3">// New data goes to geographically optimal shards</span><br/><span class="hl-1">	</span><span class="hl-5">read:</span><span class="hl-1"> </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1"> </span><span class="hl-3">// Reads use consistent hashing for best performance</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-0">collegedb</span><span class="hl-1">(</span><br/><span class="hl-1">	{</span><br/><span class="hl-1">		</span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-5">mixedStrategy</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">targetRegion:</span><span class="hl-1"> </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">, </span><span class="hl-3">// Western North America for writes</span><br/><span class="hl-1">		</span><span class="hl-5">shardLocations:</span><span class="hl-1"> {</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-5">:</span><span class="hl-1"> { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">2</span><span class="hl-1"> },</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-5">:</span><span class="hl-1"> { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;enam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">1</span><span class="hl-1"> },</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-central&#39;</span><span class="hl-5">:</span><span class="hl-1"> { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;enam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">1</span><span class="hl-1"> }</span><br/><span class="hl-1">		},</span><br/><span class="hl-1">		</span><span class="hl-5">shards:</span><span class="hl-1"> {</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_WEST</span><span class="hl-1">,</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_EAST</span><span class="hl-1">,</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-central&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_CENTRAL</span><br/><span class="hl-1">		}</span><br/><span class="hl-1">	},</span><br/><span class="hl-1">	</span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-3">// Write operations use location strategy - new users placed optimally</span><br/><span class="hl-1">		</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">run</span><span class="hl-1">(</span><span class="hl-2">&#39;user-california-456&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;INSERT INTO users (id, name, location) VALUES (?, ?, ?)&#39;</span><span class="hl-1">, [</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;user-california-456&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;California User&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;Los Angeles&#39;</span><br/><span class="hl-1">		]);</span><br/><br/><span class="hl-1">		</span><span class="hl-3">// Read operations use hash strategy - consistent and fast routing</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">user</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">first</span><span class="hl-1">&lt;</span><span class="hl-8">User</span><span class="hl-1">&gt;(</span><span class="hl-2">&#39;user-california-456&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;SELECT * FROM users WHERE id = ?&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;user-california-456&#39;</span><span class="hl-1">]);</span><br/><br/><span class="hl-1">		</span><span class="hl-3">// Different operations can route to different shards based on strategy</span><br/><span class="hl-1">		</span><span class="hl-3">// This optimizes both data placement (writes) and query performance (reads)</span><br/><span class="hl-1">		</span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`User: </span><span class="hl-7">${</span><span class="hl-5">user</span><span class="hl-10">?.</span><span class="hl-5">name</span><span class="hl-7">}</span><span class="hl-2">, Location: </span><span class="hl-7">${</span><span class="hl-5">user</span><span class="hl-10">?.</span><span class="hl-5">location</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>This approach provides:</p>
<ul>
<li><strong>Optimal data placement</strong>: New records are written to geographically optimal shards using <code>location</code> strategy</li>
<li><strong>Optimal read performance</strong>: Queries use <code>hash</code> strategy for consistent, high-performance routing</li>
<li><strong>Flexibility</strong>: Each operation type can use the most appropriate routing strategy</li>
</ul>
<h2 id="multi-key-shard-mappings" class="tsd-anchor-link">Multi-Key Shard Mappings<a href="#multi-key-shard-mappings" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>CollegeDB supports <strong>multiple lookup keys</strong> for the same record, allowing you to query by username, email, ID, or any unique identifier. Keys are automatically hashed with SHA-256 for security and privacy.</p>
<pre><code class="typescript"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">collegedb</span><span class="hl-1">, </span><span class="hl-5">first</span><span class="hl-1">, </span><span class="hl-5">run</span><span class="hl-1">, </span><span class="hl-5">KVShardMapper</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">collegedb</span><span class="hl-1">(</span><br/><span class="hl-1">	{</span><br/><span class="hl-1">		</span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">shards:</span><span class="hl-1"> { </span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_EAST</span><span class="hl-1">, </span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_WEST</span><span class="hl-1"> },</span><br/><span class="hl-1">		</span><span class="hl-5">hashShardMappings:</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1">, </span><span class="hl-3">// Default: enabled for security</span><br/><span class="hl-1">		</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;hash&#39;</span><br/><span class="hl-1">	},</span><br/><span class="hl-1">	</span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-3">// Create a user with multiple lookup keys</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">mapper</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">KVShardMapper</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">, { </span><span class="hl-5">hashShardMappings:</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1"> });</span><br/><br/><span class="hl-1">		</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">mapper</span><span class="hl-1">.</span><span class="hl-0">setShardMapping</span><span class="hl-1">(</span><span class="hl-2">&#39;user-123&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;username:john_doe&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;email:john@example.com&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;id:123&#39;</span><span class="hl-1">]);</span><br/><br/><span class="hl-1">		</span><span class="hl-3">// Now you can query by ANY of these keys</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">byId</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">first</span><span class="hl-1">(</span><span class="hl-2">&#39;user-123&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;SELECT * FROM users WHERE id = ?&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;user-123&#39;</span><span class="hl-1">]);</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">byUsername</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">first</span><span class="hl-1">(</span><span class="hl-2">&#39;username:john_doe&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;SELECT * FROM users WHERE username = ?&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;john_doe&#39;</span><span class="hl-1">]);</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">byEmail</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">first</span><span class="hl-1">(</span><span class="hl-2">&#39;email:john@example.com&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;SELECT * FROM users WHERE email = ?&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;john@example.com&#39;</span><span class="hl-1">]);</span><br/><br/><span class="hl-1">		</span><span class="hl-3">// All queries route to the same shard (db-east)</span><br/><span class="hl-1">		</span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;All queries find the same user:&#39;</span><span class="hl-1">, </span><span class="hl-5">byId</span><span class="hl-1">?.</span><span class="hl-5">name</span><span class="hl-1">);</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h3 id="adding-lookup-keys-to-existing-mappings" class="tsd-anchor-link">Adding Lookup Keys to Existing Mappings<a href="#adding-lookup-keys-to-existing-mappings" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>s</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">mapper</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">KVShardMapper</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">);</span><br/><br/><span class="hl-3">// User initially created with just ID</span><br/><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">mapper</span><span class="hl-1">.</span><span class="hl-0">setShardMapping</span><span class="hl-1">(</span><span class="hl-2">&#39;user-456&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-3">// Later, add additional lookup methods</span><br/><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">mapper</span><span class="hl-1">.</span><span class="hl-0">addLookupKeys</span><span class="hl-1">(</span><span class="hl-2">&#39;user-456&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;email:jane@example.com&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;username:jane&#39;</span><span class="hl-1">]);</span><br/><br/><span class="hl-3">// Now works with any key</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">user</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">first</span><span class="hl-1">(</span><span class="hl-2">&#39;email:jane@example.com&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;SELECT * FROM users WHERE email = ?&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;jane@example.com&#39;</span><span class="hl-1">]);</span>
</code><button type="button">Copy</button></pre>

<h3 id="security-and-privacy" class="tsd-anchor-link">Security and Privacy<a href="#security-and-privacy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>SHA-256 Hashing (Enabled by Default)</strong>: Sensitive data like emails are hashed before being stored as KV keys, protecting user privacy:</p>
<pre><code class="typescript"><span class="hl-3">// With hashShardMappings: true (default)</span><br/><span class="hl-3">// KV stores: &quot;shard:a1b2c3d4...&quot; instead of &quot;shard:email:user@example.com&quot;</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">config</span><span class="hl-1"> = {</span><br/><span class="hl-1">	</span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">shards:</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-3">/* ... */</span><br/><span class="hl-1">	},</span><br/><span class="hl-1">	</span><span class="hl-5">hashShardMappings:</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1">, </span><span class="hl-3">// Hashes keys with SHA-256</span><br/><span class="hl-1">	</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;hash&#39;</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p><strong>⚠️ Performance Trade-off</strong>: When hashing is enabled, operations like <code>getKeysForShard()</code> cannot return original key names, only hashed versions. For full key recovery, disable hashing:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">config</span><span class="hl-1"> = {</span><br/><span class="hl-1">	</span><span class="hl-5">hashShardMappings:</span><span class="hl-1"> </span><span class="hl-7">false</span><span class="hl-1"> </span><span class="hl-3">// Disables hashing - keys stored in plain text</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<h3 id="multi-key-management" class="tsd-anchor-link">Multi-Key Management<a href="#multi-key-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">mapper</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">KVShardMapper</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">);</span><br/><br/><span class="hl-3">// Get all lookup keys for a mapping</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">allKeys</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">mapper</span><span class="hl-1">.</span><span class="hl-0">getAllLookupKeys</span><span class="hl-1">(</span><span class="hl-2">&#39;email:user@example.com&#39;</span><span class="hl-1">);</span><br/><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-5">allKeys</span><span class="hl-1">); </span><span class="hl-3">// [&#39;user-123&#39;, &#39;username:john&#39;, &#39;email:user@example.com&#39;]</span><br/><br/><span class="hl-3">// Update shard assignment (updates all keys)</span><br/><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">mapper</span><span class="hl-1">.</span><span class="hl-0">updateShardMapping</span><span class="hl-1">(</span><span class="hl-2">&#39;username:john&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;db-central&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-3">// Delete mapping (removes all associated keys)</span><br/><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">mapper</span><span class="hl-1">.</span><span class="hl-0">deleteShardMapping</span><span class="hl-1">(</span><span class="hl-2">&#39;user-123&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h2 id="drop-in-replacement-for-existing-databases" class="tsd-anchor-link">Drop-in Replacement for Existing Databases<a href="#drop-in-replacement-for-existing-databases" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>CollegeDB supports <strong>seamless, automatic integration</strong> with existing D1 databases that already contain data. Simply add your existing databases as shards in the configuration. CollegeDB will automatically detect existing data and create the necessary shard mappings <strong>without requiring any manual migration steps</strong>.</p>
<h3 id="requirements-for-drop-in-replacement" class="tsd-anchor-link">Requirements for Drop-in Replacement<a href="#requirements-for-drop-in-replacement" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li><strong>Primary Keys</strong>: All tables must have a primary key column (typically named <code>id</code>)</li>
<li><strong>Schema Compatibility</strong>: Tables should use standard SQLite data types</li>
<li><strong>Access Permissions</strong>: CollegeDB needs read/write access to existing databases</li>
<li><strong>KV Namespace</strong>: A Cloudflare KV namespace for storing shard mappings</li>
</ol>
<pre><code class="typescript"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">collegedb</span><span class="hl-1">, </span><span class="hl-5">first</span><span class="hl-1">, </span><span class="hl-5">run</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Add your existing databases as shards - that&#39;s it!</span><br/><span class="hl-0">collegedb</span><span class="hl-1">(</span><br/><span class="hl-1">	{</span><br/><span class="hl-1">		</span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">shards:</span><span class="hl-1"> {</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-users&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ExistingUserDB</span><span class="hl-1">, </span><span class="hl-3">// Your existing database with users</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-orders&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ExistingOrderDB</span><span class="hl-1">, </span><span class="hl-3">// Your existing database with orders</span><br/><span class="hl-1">			</span><span class="hl-2">&#39;db-new&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">NewDB</span><span class="hl-1"> </span><span class="hl-3">// Optional new shard for growth</span><br/><span class="hl-1">		},</span><br/><span class="hl-1">		</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;hash&#39;</span><br/><span class="hl-1">	},</span><br/><span class="hl-1">	</span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-3">// Existing data works immediately!</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">existingUser</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">first</span><span class="hl-1">(</span><span class="hl-2">&#39;user-from-old-db&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;SELECT * FROM users WHERE id = ?&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;user-from-old-db&#39;</span><span class="hl-1">]);</span><br/><br/><span class="hl-1">		</span><span class="hl-3">// New data gets distributed automatically</span><br/><span class="hl-1">		</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">run</span><span class="hl-1">(</span><span class="hl-2">&#39;new-user-123&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;INSERT INTO users (id, name, email) VALUES (?, ?, ?)&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;new-user-123&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;New User&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;new@example.com&#39;</span><span class="hl-1">]);</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p><strong>That's it!</strong> No migration scripts, no manual mapping creation, no downtime. Your existing data is immediately accessible through CollegeDB's sharding system.</p>
<h3 id="manual-validation-optional" class="tsd-anchor-link">Manual Validation (Optional)<a href="#manual-validation-optional" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>You can manually validate databases before integration if needed:</p>
<pre><code class="typescript"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">validateTableForSharding</span><span class="hl-1">, </span><span class="hl-5">listTables</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Check database structure</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">tables</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">listTables</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ExistingDB</span><span class="hl-1">);</span><br/><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;Found tables:&#39;</span><span class="hl-1">, </span><span class="hl-5">tables</span><span class="hl-1">);</span><br/><br/><span class="hl-3">// Validate each table</span><br/><span class="hl-4">for</span><span class="hl-1"> (</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">table</span><span class="hl-1"> </span><span class="hl-7">of</span><span class="hl-1"> </span><span class="hl-5">tables</span><span class="hl-1">) {</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">validation</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">validateTableForSharding</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ExistingDB</span><span class="hl-1">, </span><span class="hl-5">table</span><span class="hl-1">);</span><br/><span class="hl-1">	</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">validation</span><span class="hl-1">.</span><span class="hl-5">isValid</span><span class="hl-1">) {</span><br/><span class="hl-1">		</span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`✅ </span><span class="hl-7">${</span><span class="hl-5">table</span><span class="hl-7">}</span><span class="hl-2">: </span><span class="hl-7">${</span><span class="hl-5">validation</span><span class="hl-10">.</span><span class="hl-5">recordCount</span><span class="hl-7">}</span><span class="hl-2"> records ready`</span><span class="hl-1">);</span><br/><span class="hl-1">	} </span><span class="hl-4">else</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`❌ </span><span class="hl-7">${</span><span class="hl-5">table</span><span class="hl-7">}</span><span class="hl-2">: </span><span class="hl-7">${</span><span class="hl-5">validation</span><span class="hl-10">.</span><span class="hl-5">issues</span><span class="hl-10">.</span><span class="hl-0">join</span><span class="hl-10">(</span><span class="hl-2">&#39;, &#39;</span><span class="hl-10">)</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="manual-data-discovery-optional" class="tsd-anchor-link">Manual Data Discovery (Optional)<a href="#manual-data-discovery-optional" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>If you want to inspect existing data before automatic migration:</p>
<pre><code class="typescript"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">discoverExistingPrimaryKeys</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Discover all user IDs in existing users table</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">userIds</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">discoverExistingPrimaryKeys</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ExistingDB</span><span class="hl-1">, </span><span class="hl-2">&#39;users&#39;</span><span class="hl-1">);</span><br/><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Found </span><span class="hl-7">${</span><span class="hl-5">userIds</span><span class="hl-10">.</span><span class="hl-5">length</span><span class="hl-7">}</span><span class="hl-2"> existing users`</span><span class="hl-1">);</span><br/><br/><span class="hl-3">// Custom primary key column</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">orderIds</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">discoverExistingPrimaryKeys</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ExistingDB</span><span class="hl-1">, </span><span class="hl-2">&#39;orders&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;order_id&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h3 id="manual-integration-optional" class="tsd-anchor-link">Manual Integration (Optional)<a href="#manual-integration-optional" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>For complete control over the integration process:</p>
<pre><code class="typescript"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">integrateExistingDatabase</span><span class="hl-1">, </span><span class="hl-5">KVShardMapper</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">mapper</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">KVShardMapper</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">);</span><br/><br/><span class="hl-3">// Integrate your existing database</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">result</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">integrateExistingDatabase</span><span class="hl-1">(</span><br/><span class="hl-1">	</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ExistingDB</span><span class="hl-1">, </span><span class="hl-3">// Your existing D1 database</span><br/><span class="hl-1">	</span><span class="hl-2">&#39;db-primary&#39;</span><span class="hl-1">, </span><span class="hl-3">// Shard name for this database</span><br/><span class="hl-1">	</span><span class="hl-5">mapper</span><span class="hl-1">, </span><span class="hl-3">// KV mapper instance</span><br/><span class="hl-1">	{</span><br/><span class="hl-1">		</span><span class="hl-5">tables:</span><span class="hl-1"> [</span><span class="hl-2">&#39;users&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;posts&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;orders&#39;</span><span class="hl-1">], </span><span class="hl-3">// Tables to integrate</span><br/><span class="hl-1">		</span><span class="hl-5">primaryKeyColumn:</span><span class="hl-1"> </span><span class="hl-2">&#39;id&#39;</span><span class="hl-1">, </span><span class="hl-3">// Primary key column name</span><br/><span class="hl-1">		</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1">, </span><span class="hl-3">// Allocation strategy for future records</span><br/><span class="hl-1">		</span><span class="hl-5">addShardMappingsTable:</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1">, </span><span class="hl-3">// Add CollegeDB metadata table</span><br/><span class="hl-1">		</span><span class="hl-5">dryRun:</span><span class="hl-1"> </span><span class="hl-7">false</span><span class="hl-1"> </span><span class="hl-3">// Set true for testing</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">);</span><br/><br/><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">result</span><span class="hl-1">.</span><span class="hl-5">success</span><span class="hl-1">) {</span><br/><span class="hl-1">	</span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`✅ Integrated </span><span class="hl-7">${</span><span class="hl-5">result</span><span class="hl-10">.</span><span class="hl-5">totalRecords</span><span class="hl-7">}</span><span class="hl-2"> records from </span><span class="hl-7">${</span><span class="hl-5">result</span><span class="hl-10">.</span><span class="hl-5">tablesProcessed</span><span class="hl-7">}</span><span class="hl-2"> tables`</span><span class="hl-1">);</span><br/><span class="hl-1">} </span><span class="hl-4">else</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-2">&#39;Integration issues:&#39;</span><span class="hl-1">, </span><span class="hl-5">result</span><span class="hl-1">.</span><span class="hl-5">issues</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>After integration, initialize CollegeDB with your existing databases as shards:</p>
<pre><code class="typescript"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">initialize</span><span class="hl-1">, </span><span class="hl-5">first</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Include existing databases as shards</span><br/><span class="hl-0">initialize</span><span class="hl-1">({</span><br/><span class="hl-1">	</span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">coordinator:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">shards:</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-2">&#39;db-primary&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ExistingDB</span><span class="hl-1">, </span><span class="hl-3">// Your integrated existing database</span><br/><span class="hl-1">		</span><span class="hl-2">&#39;db-secondary&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">AnotherExistingDB</span><span class="hl-1">, </span><span class="hl-3">// Another existing database</span><br/><span class="hl-1">		</span><span class="hl-2">&#39;db-new&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">NewDB</span><span class="hl-1"> </span><span class="hl-3">// Optional new shard for growth</span><br/><span class="hl-1">	},</span><br/><span class="hl-1">	</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;hash&#39;</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-3">// Existing data is now automatically routed!</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">user</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">first</span><span class="hl-1">(</span><span class="hl-2">&#39;existing-user-123&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;SELECT * FROM users WHERE id = ?&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;existing-user-123&#39;</span><span class="hl-1">]);</span>
</code><button type="button">Copy</button></pre>

<h3 id="complete-drop-in-example" class="tsd-anchor-link">Complete Drop-in Example<a href="#complete-drop-in-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The simplest possible integration - just add your existing databases:</p>
<pre><code class="typescript"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">initialize</span><span class="hl-1">, </span><span class="hl-5">first</span><span class="hl-1">, </span><span class="hl-5">run</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-4">export</span><span class="hl-1"> </span><span class="hl-4">default</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-5">request</span><span class="hl-1">: </span><span class="hl-8">Request</span><span class="hl-1">, </span><span class="hl-5">env</span><span class="hl-1">: </span><span class="hl-8">Env</span><span class="hl-1">): </span><span class="hl-8">Promise</span><span class="hl-1">&lt;</span><span class="hl-8">Response</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">		</span><span class="hl-3">// Step 1: Initialize with existing databases (automatic migration happens here!)</span><br/><span class="hl-1">		</span><span class="hl-0">initialize</span><span class="hl-1">({</span><br/><span class="hl-1">			</span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">			</span><span class="hl-5">shards:</span><span class="hl-1"> {</span><br/><span class="hl-1">				</span><span class="hl-2">&#39;db-users&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ExistingUserDB</span><span class="hl-1">, </span><span class="hl-3">// Your existing database with users</span><br/><span class="hl-1">				</span><span class="hl-2">&#39;db-orders&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ExistingOrderDB</span><span class="hl-1">, </span><span class="hl-3">// Your existing database with orders</span><br/><span class="hl-1">				</span><span class="hl-2">&#39;db-new&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">NewDB</span><span class="hl-1"> </span><span class="hl-3">// New shard for future growth</span><br/><span class="hl-1">			},</span><br/><span class="hl-1">			</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;hash&#39;</span><br/><span class="hl-1">		});</span><br/><br/><span class="hl-1">		</span><span class="hl-3">// Step 2: Use existing data immediately - no migration needed!</span><br/><span class="hl-1">		</span><span class="hl-3">// Supports typed queries, inserts, updates, deletes, etc.</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">existingUser</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">first</span><span class="hl-1">&lt;</span><span class="hl-8">User</span><span class="hl-1">&gt;(</span><span class="hl-2">&#39;user-from-old-db&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;SELECT * FROM users WHERE id = ?&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;user-from-old-db&#39;</span><span class="hl-1">]);</span><br/><br/><span class="hl-1">		</span><span class="hl-3">// Step 3: New data gets distributed automatically</span><br/><span class="hl-1">		</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">run</span><span class="hl-1">(</span><span class="hl-2">&#39;new-user-123&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;INSERT INTO users (id, name, email) VALUES (?, ?, ?)&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;new-user-123&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;New User&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;new@example.com&#39;</span><span class="hl-1">]);</span><br/><br/><span class="hl-1">		</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Response</span><span class="hl-1">(</span><br/><span class="hl-1">			</span><span class="hl-6">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({</span><br/><span class="hl-1">				</span><span class="hl-5">existingUser:</span><span class="hl-1"> </span><span class="hl-5">existingUser</span><span class="hl-1">.</span><span class="hl-5">results</span><span class="hl-1">[</span><span class="hl-9">0</span><span class="hl-1">],</span><br/><span class="hl-1">				</span><span class="hl-5">message:</span><span class="hl-1"> </span><span class="hl-2">&#39;Automatic drop-in replacement successful!&#39;</span><br/><span class="hl-1">			})</span><br/><span class="hl-1">		);</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<h3 id="manual-integration-example" class="tsd-anchor-link">Manual Integration Example<a href="#manual-integration-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>If your tables use different primary key column names:</p>
<pre><code class="typescript"><span class="hl-3">// For tables with custom primary key columns</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">productIds</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">discoverExistingPrimaryKeys</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ProductDB</span><span class="hl-1">, </span><span class="hl-2">&#39;products&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;product_id&#39;</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">sessionIds</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">discoverExistingPrimaryKeys</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">SessionDB</span><span class="hl-1">, </span><span class="hl-2">&#39;sessions&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;session_key&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>Integrate only specific tables from existing databases:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">result</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">integrateExistingDatabase</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ExistingDB</span><span class="hl-1">, </span><span class="hl-2">&#39;db-legacy&#39;</span><span class="hl-1">, </span><span class="hl-5">mapper</span><span class="hl-1">, {</span><br/><span class="hl-1">	</span><span class="hl-5">tables:</span><span class="hl-1"> [</span><span class="hl-2">&#39;users&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;orders&#39;</span><span class="hl-1">] </span><span class="hl-3">// Only integrate these tables</span><br/><span class="hl-1">	</span><span class="hl-3">// Skip &#39;temp_logs&#39;, &#39;cache_data&#39;, etc.</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>Test integration without making changes:</p>
<pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">testResult</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">integrateExistingDatabase</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ExistingDB</span><span class="hl-1">, </span><span class="hl-2">&#39;db-test&#39;</span><span class="hl-1">, </span><span class="hl-5">mapper</span><span class="hl-1">, {</span><br/><span class="hl-1">	</span><span class="hl-5">dryRun:</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1"> </span><span class="hl-3">// No actual mappings created</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Would process </span><span class="hl-7">${</span><span class="hl-5">testResult</span><span class="hl-10">.</span><span class="hl-5">totalRecords</span><span class="hl-7">}</span><span class="hl-2"> records from </span><span class="hl-7">${</span><span class="hl-5">testResult</span><span class="hl-10">.</span><span class="hl-5">tablesProcessed</span><span class="hl-7">}</span><span class="hl-2"> tables`</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h3 id="performance-impact" class="tsd-anchor-link">Performance Impact<a href="#performance-impact" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li><strong>One-time Setup</strong>: Migration detection runs once per shard</li>
<li><strong>Minimal Overhead</strong>: Only scans table metadata and sample records</li>
<li><strong>Cached Results</strong>: Subsequent operations have no migration overhead</li>
<li><strong>Async Processing</strong>: Doesn't block application startup or queries</li>
</ul>
<pre><code class="typescript"><span class="hl-3">// Simple rollback - clear all mappings</span><br/><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">KVShardMapper</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">mapper</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">KVShardMapper</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">);</span><br/><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">mapper</span><span class="hl-1">.</span><span class="hl-0">clearAllMappings</span><span class="hl-1">(); </span><span class="hl-3">// Returns to pre-migration state</span><br/><br/><span class="hl-3">// Or clear cache to force re-detection</span><br/><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">clearMigrationCache</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><span class="hl-0">clearMigrationCache</span><span class="hl-1">(); </span><span class="hl-3">// Forces fresh migration check</span>
</code><button type="button">Copy</button></pre>

<h2 id="troubleshooting" class="tsd-anchor-link">Troubleshooting<a href="#troubleshooting" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="tables-without-primary-keys" class="tsd-anchor-link">Tables without Primary Keys<a href="#tables-without-primary-keys" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">// Error: Primary key column &#39;id&#39; not found</span><br/><span class="hl-3">// Solution: Add primary key to existing table</span><br/><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">db</span><span class="hl-1">.</span><span class="hl-0">prepare</span><span class="hl-1">(</span><span class="hl-2">`ALTER TABLE legacy_table ADD COLUMN id TEXT PRIMARY KEY`</span><span class="hl-1">).</span><span class="hl-0">run</span><span class="hl-1">();</span>
</code><button type="button">Copy</button></pre>

<h3 id="large-database-integration" class="tsd-anchor-link">Large Database Integration<a href="#large-database-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">// For very large databases, integrate in batches</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">allTables</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">listTables</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">LargeDB</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">batchSize</span><span class="hl-1"> = </span><span class="hl-9">2</span><span class="hl-1">;</span><br/><br/><span class="hl-4">for</span><span class="hl-1"> (</span><span class="hl-7">let</span><span class="hl-1"> </span><span class="hl-5">i</span><span class="hl-1"> = </span><span class="hl-9">0</span><span class="hl-1">; </span><span class="hl-5">i</span><span class="hl-1"> &lt; </span><span class="hl-5">allTables</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1">; </span><span class="hl-5">i</span><span class="hl-1"> += </span><span class="hl-5">batchSize</span><span class="hl-1">) {</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">batch</span><span class="hl-1"> = </span><span class="hl-5">allTables</span><span class="hl-1">.</span><span class="hl-0">slice</span><span class="hl-1">(</span><span class="hl-5">i</span><span class="hl-1">, </span><span class="hl-5">i</span><span class="hl-1"> + </span><span class="hl-5">batchSize</span><span class="hl-1">);</span><br/><span class="hl-1">	</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">integrateExistingDatabase</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">LargeDB</span><span class="hl-1">, </span><span class="hl-2">&#39;db-large&#39;</span><span class="hl-1">, </span><span class="hl-5">mapper</span><span class="hl-1">, {</span><br/><span class="hl-1">		</span><span class="hl-5">tables:</span><span class="hl-1"> </span><span class="hl-5">batch</span><br/><span class="hl-1">	});</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="mixed-primary-key-types" class="tsd-anchor-link">Mixed Primary Key Types<a href="#mixed-primary-key-types" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-3">// Handle different primary key column names per table</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">customIntegration</span><span class="hl-1"> = {</span><br/><span class="hl-1">	</span><span class="hl-5">users:</span><span class="hl-1"> </span><span class="hl-2">&#39;user_id&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">orders:</span><span class="hl-1"> </span><span class="hl-2">&#39;order_number&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">products:</span><span class="hl-1"> </span><span class="hl-2">&#39;sku&#39;</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-4">for</span><span class="hl-1"> (</span><span class="hl-7">const</span><span class="hl-1"> [</span><span class="hl-6">table</span><span class="hl-1">, </span><span class="hl-6">pkColumn</span><span class="hl-1">] </span><span class="hl-7">of</span><span class="hl-1"> </span><span class="hl-5">Object</span><span class="hl-1">.</span><span class="hl-0">entries</span><span class="hl-1">(</span><span class="hl-5">customIntegration</span><span class="hl-1">)) {</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">keys</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">discoverExistingPrimaryKeys</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB</span><span class="hl-1">, </span><span class="hl-5">table</span><span class="hl-1">, </span><span class="hl-5">pkColumn</span><span class="hl-1">);</span><br/><span class="hl-1">	</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">createMappingsForExistingKeys</span><span class="hl-1">(</span><span class="hl-5">keys</span><span class="hl-1">, [</span><span class="hl-2">&#39;db-shard1&#39;</span><span class="hl-1">], </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1">, </span><span class="hl-5">mapper</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h2 id="📚-api-reference" class="tsd-anchor-link">📚 API Reference<a href="#📚-api-reference" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
<th>Parameters</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>collegedb(config, callback)</code></td>
<td>Initialize CollegeDB, then run a callback</td>
<td><code>CollegeDBConfig, () =&gt; T</code></td>
</tr>
<tr>
<td><code>initialize(config)</code></td>
<td>Initialize CollegeDB with configuration</td>
<td><code>CollegeDBConfig</code></td>
</tr>
<tr>
<td><code>createSchema(d1)</code></td>
<td>Create database schema on a D1 instance</td>
<td><code>D1Database</code></td>
</tr>
<tr>
<td><code>prepare(key, sql)</code></td>
<td>Prepare a SQL statement for execution</td>
<td><code>string, string</code></td>
</tr>
<tr>
<td><code>run(key, sql, bindings)</code></td>
<td>Execute a SQL query with primary key routing</td>
<td><code>string, string, any[]</code></td>
</tr>
<tr>
<td><code>first(key, sql, bindings)</code></td>
<td>Execute a SQL query and return first result</td>
<td><code>string, string, any[]</code></td>
</tr>
<tr>
<td><code>all(key, sql, bindings)</code></td>
<td>Execute a SQL query and return all results</td>
<td><code>string, string, any[]</code></td>
</tr>
<tr>
<td><code>runShard(shard, sql, bindings)</code></td>
<td>Execute a query directly on a specific shard</td>
<td><code>string, string, any[]</code></td>
</tr>
<tr>
<td><code>allShard(shard, sql, bindings)</code></td>
<td>Execute a query on specific shard, return all results</td>
<td><code>string, string, any[]</code></td>
</tr>
<tr>
<td><code>firstShard(shard, sql, bindings)</code></td>
<td>Execute a query on specific shard, return first result</td>
<td><code>string, string, any[]</code></td>
</tr>
<tr>
<td><code>runAllShards(sql, bindings, batchSize)</code></td>
<td>Execute query on all shards</td>
<td><code>string, any[], number</code></td>
</tr>
<tr>
<td><code>allAllShards(sql, bindings, batchSize)</code></td>
<td>Execute query on all shards, return all results from all shards</td>
<td><code>string, any[], number</code></td>
</tr>
<tr>
<td><code>firstAllShards(sql, bindings, batchSize)</code></td>
<td>Execute query on all shards, return first result from all shards</td>
<td><code>string, any[], number</code></td>
</tr>
<tr>
<td><code>reassignShard(key, newShard)</code></td>
<td>Move primary key to different shard</td>
<td><code>string, string</code></td>
</tr>
<tr>
<td><code>listKnownShards()</code></td>
<td>Get list of available shards</td>
<td><code>void</code></td>
</tr>
<tr>
<td><code>getShardStats()</code></td>
<td>Get statistics for all shards</td>
<td><code>void</code></td>
</tr>
<tr>
<td><code>flush()</code></td>
<td>Clear all shard mappings (development only)</td>
<td><code>void</code></td>
</tr>
</tbody>
</table>
<h3 id="drop-in-replacement-functions" class="tsd-anchor-link">Drop-in Replacement Functions<a href="#drop-in-replacement-functions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
<th>Parameters</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>autoDetectAndMigrate(d1, shard, config)</code></td>
<td>Automatically detect and migrate existing data</td>
<td><code>D1Database, string, config</code></td>
</tr>
<tr>
<td><code>checkMigrationNeeded(d1, shard, config)</code></td>
<td>Check if database needs migration</td>
<td><code>D1Database, string, config</code></td>
</tr>
<tr>
<td><code>validateTableForSharding(d1, table)</code></td>
<td>Check if table is suitable for sharding</td>
<td><code>D1Database, string</code></td>
</tr>
<tr>
<td><code>discoverExistingPrimaryKeys(d1, table)</code></td>
<td>Find all primary keys in existing table</td>
<td><code>D1Database, string</code></td>
</tr>
<tr>
<td><code>integrateExistingDatabase(d1, shard)</code></td>
<td>Complete drop-in integration of existing DB</td>
<td><code>D1Database, string, mapper</code></td>
</tr>
<tr>
<td><code>createMappingsForExistingKeys(keys)</code></td>
<td>Create shard mappings for existing keys</td>
<td><code>string[], string[], strategy</code></td>
</tr>
<tr>
<td><code>listTables(d1)</code></td>
<td>Get list of tables in database</td>
<td><code>D1Database</code></td>
</tr>
<tr>
<td><code>clearMigrationCache()</code></td>
<td>Clear automatic migration cache</td>
<td><code>void</code></td>
</tr>
</tbody>
</table>
<h3 id="error-handling" class="tsd-anchor-link">Error Handling<a href="#error-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Class</th>
<th>Description</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CollegeDBError</code></td>
<td>Custom error class for CollegeDB operations</td>
<td><code>throw new CollegeDBError(msg, code)</code></td>
</tr>
</tbody>
</table>
<p>The <code>CollegeDBError</code> class extends the native <code>Error</code> class and includes an optional error code for better error categorization:</p>
<pre><code class="typescript"><span class="hl-4">try</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">run</span><span class="hl-1">(</span><span class="hl-2">&#39;invalid-key&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;SELECT * FROM users WHERE id = ?&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;invalid-key&#39;</span><span class="hl-1">]);</span><br/><span class="hl-1">} </span><span class="hl-4">catch</span><span class="hl-1"> (</span><span class="hl-5">error</span><span class="hl-1">) {</span><br/><span class="hl-1">	</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">error</span><span class="hl-1"> </span><span class="hl-7">instanceof</span><span class="hl-1"> </span><span class="hl-8">CollegeDBError</span><span class="hl-1">) {</span><br/><span class="hl-1">		</span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-2">`CollegeDB Error (</span><span class="hl-7">${</span><span class="hl-5">error</span><span class="hl-10">.</span><span class="hl-5">code</span><span class="hl-7">}</span><span class="hl-2">): </span><span class="hl-7">${</span><span class="hl-5">error</span><span class="hl-10">.</span><span class="hl-5">message</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="shardcoordinator-durable-object-api" class="tsd-anchor-link">ShardCoordinator (Durable Object) API<a href="#shardcoordinator-durable-object-api" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>ShardCoordinator</code> is an optional Durable Object that provides centralized shard allocation and statistics management. All endpoints return JSON responses.</p>
<h4 id="http-api-endpoints" class="tsd-anchor-link">HTTP API Endpoints<a href="#http-api-endpoints" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th>Endpoint</th>
<th>Method</th>
<th>Description</th>
<th>Request Body</th>
<th>Response</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/shards</code></td>
<td>GET</td>
<td>List all registered shards</td>
<td>None</td>
<td><code>[&quot;db-east&quot;, &quot;db-west&quot;]</code></td>
</tr>
<tr>
<td><code>/shards</code></td>
<td>POST</td>
<td>Register a new shard</td>
<td><code>{&quot;shard&quot;: &quot;db-new&quot;}</code></td>
<td><code>{&quot;success&quot;: true}</code></td>
</tr>
<tr>
<td><code>/shards</code></td>
<td>DELETE</td>
<td>Unregister a shard</td>
<td><code>{&quot;shard&quot;: &quot;db-old&quot;}</code></td>
<td><code>{&quot;success&quot;: true}</code></td>
</tr>
<tr>
<td><code>/stats</code></td>
<td>GET</td>
<td>Get shard statistics</td>
<td>None</td>
<td><code>[{&quot;binding&quot;:&quot;db-east&quot;,&quot;count&quot;:1542}]</code></td>
</tr>
<tr>
<td><code>/stats</code></td>
<td>POST</td>
<td>Update shard statistics</td>
<td><code>{&quot;shard&quot;: &quot;db-east&quot;, &quot;count&quot;: 1600}</code></td>
<td><code>{&quot;success&quot;: true}</code></td>
</tr>
<tr>
<td><code>/allocate</code></td>
<td>POST</td>
<td>Allocate shard for primary key</td>
<td><code>{&quot;primaryKey&quot;: &quot;user-123&quot;}</code></td>
<td><code>{&quot;shard&quot;: &quot;db-west&quot;}</code></td>
</tr>
<tr>
<td><code>/allocate</code></td>
<td>POST</td>
<td>Allocate with specific strategy</td>
<td><code>{&quot;primaryKey&quot;: &quot;user-123&quot;, &quot;strategy&quot;: &quot;hash&quot;}</code></td>
<td><code>{&quot;shard&quot;: &quot;db-west&quot;}</code></td>
</tr>
<tr>
<td><code>/flush</code></td>
<td>POST</td>
<td>Clear all state (development only)</td>
<td>None</td>
<td><code>{&quot;success&quot;: true}</code></td>
</tr>
<tr>
<td><code>/health</code></td>
<td>GET</td>
<td>Health check</td>
<td>None</td>
<td><code>&quot;OK&quot;</code></td>
</tr>
</tbody>
</table>
<h4 id="programmatic-methods" class="tsd-anchor-link">Programmatic Methods<a href="#programmatic-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
<th>Parameters</th>
<th>Returns</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>new ShardCoordinator(state)</code></td>
<td>Create coordinator instance</td>
<td><code>DurableObjectState</code></td>
<td><code>ShardCoordinator</code></td>
</tr>
<tr>
<td><code>fetch(request)</code></td>
<td>Handle HTTP requests</td>
<td><code>Request</code></td>
<td><code>Promise&lt;Response&gt;</code></td>
</tr>
<tr>
<td><code>incrementShardCount(shard)</code></td>
<td>Increment key count for shard</td>
<td><code>string</code></td>
<td><code>Promise&lt;void&gt;</code></td>
</tr>
<tr>
<td><code>decrementShardCount(shard)</code></td>
<td>Decrement key count for shard</td>
<td><code>string</code></td>
<td><code>Promise&lt;void&gt;</code></td>
</tr>
</tbody>
</table>
<h4 id="usage-example" class="tsd-anchor-link">Usage Example<a href="#usage-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">ShardCoordinator</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Export for Cloudflare Workers runtime</span><br/><span class="hl-4">export</span><span class="hl-1"> { </span><span class="hl-5">ShardCoordinator</span><span class="hl-1"> };</span><br/><br/><span class="hl-3">// Use in your worker</span><br/><span class="hl-4">export</span><span class="hl-1"> </span><span class="hl-4">default</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-5">request</span><span class="hl-1">: </span><span class="hl-8">Request</span><span class="hl-1">, </span><span class="hl-5">env</span><span class="hl-1">: </span><span class="hl-8">Env</span><span class="hl-1">) {</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinatorId</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">idFromName</span><span class="hl-1">(</span><span class="hl-2">&#39;default&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinator</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-5">coordinatorId</span><span class="hl-1">);</span><br/><br/><span class="hl-1">		</span><span class="hl-3">// Allocate shard for user</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">response</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/allocate&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">			</span><span class="hl-5">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;POST&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">			</span><span class="hl-5">headers:</span><span class="hl-1"> { </span><span class="hl-2">&#39;Content-Type&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-2">&#39;application/json&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">			</span><span class="hl-5">body:</span><span class="hl-1"> </span><span class="hl-6">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({ </span><span class="hl-5">primaryKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;user-123&#39;</span><span class="hl-1">, </span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1"> })</span><br/><span class="hl-1">		});</span><br/><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> { </span><span class="hl-6">shard</span><span class="hl-1"> } = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">response</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">();</span><br/><span class="hl-1">		</span><span class="hl-3">// Use allocated shard for database operations...</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<h3 id="configuration-types" class="tsd-anchor-link">Configuration Types<a href="#configuration-types" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><h4 id="collegedbconfig" class="tsd-anchor-link">CollegeDBConfig<a href="#collegedbconfig" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p>The main configuration interface supports both single strategies and mixed strategies:</p>
<pre><code class="typescript"><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-8">CollegeDBConfig</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-5">kv</span><span class="hl-1">: </span><span class="hl-8">KVNamespace</span><span class="hl-1">;</span><br/><span class="hl-1">	</span><span class="hl-5">coordinator</span><span class="hl-1">?: </span><span class="hl-8">DurableObjectNamespace</span><span class="hl-1">;</span><br/><span class="hl-1">	</span><span class="hl-5">shards</span><span class="hl-1">: </span><span class="hl-8">Record</span><span class="hl-1">&lt;</span><span class="hl-8">string</span><span class="hl-1">, </span><span class="hl-8">D1Database</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">	</span><span class="hl-5">strategy</span><span class="hl-1">?: </span><span class="hl-8">ShardingStrategy</span><span class="hl-1"> | </span><span class="hl-8">MixedShardingStrategy</span><span class="hl-1">;</span><br/><span class="hl-1">	</span><span class="hl-5">targetRegion</span><span class="hl-1">?: </span><span class="hl-8">D1Region</span><span class="hl-1">;</span><br/><span class="hl-1">	</span><span class="hl-5">shardLocations</span><span class="hl-1">?: </span><span class="hl-8">Record</span><span class="hl-1">&lt;</span><span class="hl-8">string</span><span class="hl-1">, </span><span class="hl-8">ShardLocation</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">	</span><span class="hl-5">disableAutoMigration</span><span class="hl-1">?: </span><span class="hl-8">boolean</span><span class="hl-1">; </span><span class="hl-3">// Default: false</span><br/><span class="hl-1">	</span><span class="hl-5">hashShardMappings</span><span class="hl-1">?: </span><span class="hl-8">boolean</span><span class="hl-1">; </span><span class="hl-3">// Default: true</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>When <code>hashShardMappings</code> is enabled (default), original keys cannot be recovered during shard operations like <code>getKeysForShard()</code>. This is intentional for privacy but means you'll get fewer results from such operations. For full key recovery, set <code>hashShardMappings: false</code>, but be aware this may expose sensitive data in KV keys.</p>
<h4 id="strategy-types" class="tsd-anchor-link">Strategy Types<a href="#strategy-types" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-3">// Single strategy for all operations</span><br/><span class="hl-7">type</span><span class="hl-1"> </span><span class="hl-8">ShardingStrategy</span><span class="hl-1"> = </span><span class="hl-2">&#39;round-robin&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;random&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;location&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Mixed strategy for different operation types</span><br/><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-8">MixedShardingStrategy</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-5">read</span><span class="hl-1">: </span><span class="hl-8">ShardingStrategy</span><span class="hl-1">; </span><span class="hl-3">// Strategy for SELECT operations</span><br/><span class="hl-1">	</span><span class="hl-5">write</span><span class="hl-1">: </span><span class="hl-8">ShardingStrategy</span><span class="hl-1">; </span><span class="hl-3">// Strategy for INSERT/UPDATE/DELETE operations</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-3">// Operation types for internal routing</span><br/><span class="hl-7">type</span><span class="hl-1"> </span><span class="hl-8">OperationType</span><span class="hl-1"> = </span><span class="hl-2">&#39;read&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;write&#39;</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<h4 id="example-configurations" class="tsd-anchor-link">Example Configurations<a href="#example-configurations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-3">// Single strategy configuration (traditional)</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">singleStrategyConfig</span><span class="hl-1">: </span><span class="hl-8">CollegeDBConfig</span><span class="hl-1"> = {</span><br/><span class="hl-1">	</span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1">, </span><span class="hl-3">// All operations use hash strategy</span><br/><span class="hl-1">	</span><span class="hl-5">shards:</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-3">/* ... */</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-3">// Mixed strategy configuration (new feature)</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">mixedStrategyConfig</span><span class="hl-1">: </span><span class="hl-8">CollegeDBConfig</span><span class="hl-1"> = {</span><br/><span class="hl-1">	</span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">strategy:</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-5">read:</span><span class="hl-1"> </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1">, </span><span class="hl-3">// Fast, consistent reads</span><br/><span class="hl-1">		</span><span class="hl-5">write:</span><span class="hl-1"> </span><span class="hl-2">&#39;location&#39;</span><span class="hl-1"> </span><span class="hl-3">// Optimal data placement</span><br/><span class="hl-1">	},</span><br/><span class="hl-1">	</span><span class="hl-5">targetRegion:</span><span class="hl-1"> </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">shardLocations:</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-3">/* ... */</span><br/><span class="hl-1">	},</span><br/><span class="hl-1">	</span><span class="hl-5">shards:</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-3">/* ... */</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<h3 id="types" class="tsd-anchor-link">Types<a href="#types" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>CollegeDB exports TypeScript types for better development experience and type safety:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CollegeDBConfig</code></td>
<td>Main configuration object</td>
<td><code>{ kv, shards, strategy }</code></td>
</tr>
<tr>
<td><code>ShardingStrategy</code></td>
<td>Single strategy options</td>
<td><code>'hash' | 'location' | 'round-robin' | 'random'</code></td>
</tr>
<tr>
<td><code>MixedShardingStrategy</code></td>
<td>Mixed strategy configuration</td>
<td><code>{ read: 'hash', write: 'location' }</code></td>
</tr>
<tr>
<td><code>OperationType</code></td>
<td>Database operation types</td>
<td><code>'read' | 'write'</code></td>
</tr>
<tr>
<td><code>D1Region</code></td>
<td>Cloudflare D1 regions</td>
<td><code>'wnam' | 'enam' | 'weur' | ...</code></td>
</tr>
<tr>
<td><code>ShardLocation</code></td>
<td>Geographic shard configuration</td>
<td><code>{ region: 'wnam', priority: 2 }</code></td>
</tr>
<tr>
<td><code>ShardStats</code></td>
<td>Shard usage statistics</td>
<td><code>{ binding: 'db-east', count: 1542 }</code></td>
</tr>
</tbody>
</table>
<h4 id="mixed-strategy-configuration" class="tsd-anchor-link">Mixed Strategy Configuration<a href="#mixed-strategy-configuration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-4">import</span><span class="hl-1"> </span><span class="hl-4">type</span><span class="hl-1"> { </span><span class="hl-5">MixedShardingStrategy</span><span class="hl-1">, </span><span class="hl-5">CollegeDBConfig</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Type-safe mixed strategy configuration</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">mixedStrategy</span><span class="hl-1">: </span><span class="hl-8">MixedShardingStrategy</span><span class="hl-1"> = {</span><br/><span class="hl-1">	</span><span class="hl-5">read:</span><span class="hl-1"> </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1">, </span><span class="hl-3">// Fast, deterministic reads</span><br/><span class="hl-1">	</span><span class="hl-5">write:</span><span class="hl-1"> </span><span class="hl-2">&#39;location&#39;</span><span class="hl-1"> </span><span class="hl-3">// Geographically optimized writes</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">config</span><span class="hl-1">: </span><span class="hl-8">CollegeDBConfig</span><span class="hl-1"> = {</span><br/><span class="hl-1">	</span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-5">mixedStrategy</span><span class="hl-1">, </span><span class="hl-3">// Type-checked</span><br/><span class="hl-1">	</span><span class="hl-5">targetRegion:</span><span class="hl-1"> </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">shardLocations:</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-5">:</span><span class="hl-1"> { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">2</span><span class="hl-1"> },</span><br/><span class="hl-1">		</span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-5">:</span><span class="hl-1"> { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;enam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">1</span><span class="hl-1"> }</span><br/><span class="hl-1">	},</span><br/><span class="hl-1">	</span><span class="hl-5">shards:</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_WEST</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_EAST</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<h2 id="🏗-architecture" class="tsd-anchor-link">🏗 Architecture<a href="#🏗-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="txt">┌─────────────────────────────────────────────────────────────┐
│                    Cloudflare Worker                        │
├─────────────────────────────────────────────────────────────┤
│                     CollegeDB Router                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │     KV      │  │  Durable    │  │   Query Router      │  │
│  │  Mappings   │  │  Objects    │  │                     │  │
│  │             │  │ (Optional)  │  │                     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   D1 East   │  │  D1 West    │  │    D1 Central       │  │
│  │   Shard     │  │   Shard     │  │     Shard           │  │
│  │             │  │             │  │   (Optional)        │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
</code><button type="button">Copy</button></pre>

<h3 id="data-flow" class="tsd-anchor-link">Data Flow<a href="#data-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><h4 id="without-shardcoordinator-hashrandomlocation-strategies" class="tsd-anchor-link">Without ShardCoordinator (Hash/Random/Location strategies)<a href="#without-shardcoordinator-hashrandomlocation-strategies" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><ol>
<li><strong>Query Received</strong>: Application sends query with primary key</li>
<li><strong>Shard Resolution</strong>: CollegeDB checks KV for existing mapping or calculates shard using strategy</li>
<li><strong>Direct Allocation</strong>: For new keys, shard selected using hash/random/location algorithm</li>
<li><strong>Query Execution</strong>: SQL executed on appropriate D1 database</li>
<li><strong>Response</strong>: Results returned to application</li>
</ol>
<h4 id="with-shardcoordinator-round-robin-strategy" class="tsd-anchor-link">With ShardCoordinator (Round-Robin strategy)<a href="#with-shardcoordinator-round-robin-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><ol>
<li><strong>Query Received</strong>: Application sends query with primary key</li>
<li><strong>Shard Resolution</strong>: CollegeDB checks KV for existing mapping</li>
<li><strong>Coordinator Allocation</strong>: For new keys, coordinator allocates shard using round-robin</li>
<li><strong>State Update</strong>: Coordinator updates round-robin index and shard statistics</li>
<li><strong>Query Execution</strong>: SQL executed on appropriate D1 database</li>
<li><strong>Response</strong>: Results returned to application</li>
</ol>
<h4 id="shardcoordinator-internal-flow" class="tsd-anchor-link">ShardCoordinator Internal Flow<a href="#shardcoordinator-internal-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="txt">┌─────────────────────────────────────────────────────────────┐
│              ShardCoordinator (Durable Object)             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────────────────────┐  │
│  │  HTTP API       │  │       Persistent Storage        │  │
│  │  - /allocate    │  │  - knownShards: string[]        │  │
│  │  - /shards      │  │  - shardStats: ShardStats{}     │  │
│  │  - /stats       │  │  - strategy: ShardingStrategy   │  │
│  │  - /health      │  │  - roundRobinIndex: number      │  │
│  └─────────────────┘  └─────────────────────────────────┘  │
│                                  │                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           Allocation Algorithms                     │   │
│  │  - Round-Robin: state.roundRobinIndex               │   │
│  │  - Hash: consistent hash(primaryKey)                │   │
│  │  - Random: Math.random() * shards.length            │   │
│  │  - Location: region proximity + priority            │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
</code><button type="button">Copy</button></pre>

<h3 id="shard-allocation-strategies" class="tsd-anchor-link">Shard Allocation Strategies<a href="#shard-allocation-strategies" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li><strong>Hash</strong>: Consistent hashing for deterministic shard selection</li>
<li><strong>Round-Robin</strong>: Evenly distribute new keys across shards</li>
<li><strong>Random</strong>: Random shard selection for load balancing</li>
<li><strong>Location</strong>: Geographic proximity-based allocation for optimal latency</li>
</ul>
<h2 id="🌐-cloudflare-setup" class="tsd-anchor-link">🌐 Cloudflare Setup<a href="#🌐-cloudflare-setup" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="1-create-d1-databases" class="tsd-anchor-link">1. Create D1 Databases<a href="#1-create-d1-databases" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="bash"><span class="hl-3"># Create multiple D1 databases for sharding</span><br/><span class="hl-0">wrangler</span><span class="hl-1"> </span><span class="hl-2">d1</span><span class="hl-1"> </span><span class="hl-2">create</span><span class="hl-1"> </span><span class="hl-2">collegedb-east</span><br/><span class="hl-0">wrangler</span><span class="hl-1"> </span><span class="hl-2">d1</span><span class="hl-1"> </span><span class="hl-2">create</span><span class="hl-1"> </span><span class="hl-2">collegedb-west</span><br/><span class="hl-0">wrangler</span><span class="hl-1"> </span><span class="hl-2">d1</span><span class="hl-1"> </span><span class="hl-2">create</span><span class="hl-1"> </span><span class="hl-2">collegedb-central</span>
</code><button type="button">Copy</button></pre>

<h3 id="2-create-kv-namespace" class="tsd-anchor-link">2. Create KV Namespace<a href="#2-create-kv-namespace" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="bash"><span class="hl-3"># Create KV namespace for shard mappings</span><br/><span class="hl-0">wrangler</span><span class="hl-1"> </span><span class="hl-2">kv</span><span class="hl-1"> </span><span class="hl-2">namespace</span><span class="hl-1"> </span><span class="hl-2">create</span><span class="hl-1"> </span><span class="hl-2">&quot;KV&quot;</span>
</code><button type="button">Copy</button></pre>

<h3 id="3-configure-wranglertoml" class="tsd-anchor-link">3. Configure wrangler.toml<a href="#3-configure-wranglertoml" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="toml">[[d1_databases]]
binding = "db-east"
database_name = "collegedb-east"
database_id = "your-database-id"

[[d1_databases]]
binding = "db-west"
database_name = "collegedb-west"
database_id = "your-database-id"

[[kv_namespaces]]
binding = "KV"
id = "your-kv-namespace-id"

[[durable_objects.bindings]]
name = "ShardCoordinator"
class_name = "ShardCoordinator"
</code><button type="button">Copy</button></pre>

<h4 id="complete-wranglertoml-with-shardcoordinator" class="tsd-anchor-link">Complete wrangler.toml with ShardCoordinator<a href="#complete-wranglertoml-with-shardcoordinator" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="toml">name = "collegedb-app"
main = "src/index.ts"
compatibility_date = "2024-08-10"

# D1 Database bindings
[[d1_databases]]
binding = "db-east"
database_name = "collegedb-east"
database_id = "your-east-database-id"

[[d1_databases]]
binding = "db-west"
database_name = "collegedb-west"
database_id = "your-west-database-id"

[[d1_databases]]
binding = "db-central"
database_name = "collegedb-central"
database_id = "your-central-database-id"

# KV namespace for shard mappings
[[kv_namespaces]]
binding = "KV"
id = "your-kv-namespace-id"
preview_id = "your-kv-preview-id" # For local development

# Durable Object for shard coordination
[[durable_objects.bindings]]
name = "ShardCoordinator"
class_name = "ShardCoordinator"

# Environment-specific configurations
[env.production]
[[env.production.d1_databases]]
binding = "db-east"
database_name = "collegedb-prod-east"
database_id = "your-prod-east-id"

[[env.production.d1_databases]]
binding = "db-west"
database_name = "collegedb-prod-west"
database_id = "your-prod-west-id"

[[env.production.kv_namespaces]]
binding = "KV"
id = "your-prod-kv-namespace-id"

[[env.production.durable_objects.bindings]]
name = "ShardCoordinator"
class_name = "ShardCoordinator"
</code><button type="button">Copy</button></pre>

<h3 id="31-worker-script-setup-required-for-shardcoordinator" class="tsd-anchor-link">3.1. Worker Script Setup (Required for ShardCoordinator)<a href="#31-worker-script-setup-required-for-shardcoordinator" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Create your main worker file with ShardCoordinator export:</p>
<pre><code class="typescript"><span class="hl-3">// src/index.ts</span><br/><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">collegedb</span><span class="hl-1">, </span><span class="hl-5">ShardCoordinator</span><span class="hl-1">, </span><span class="hl-5">first</span><span class="hl-1">, </span><span class="hl-5">run</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// IMPORTANT: Export ShardCoordinator for Cloudflare Workers runtime</span><br/><span class="hl-4">export</span><span class="hl-1"> { </span><span class="hl-5">ShardCoordinator</span><span class="hl-1"> };</span><br/><br/><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-8">Env</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-5">KV</span><span class="hl-1">: </span><span class="hl-8">KVNamespace</span><span class="hl-1">;</span><br/><span class="hl-1">	</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">: </span><span class="hl-8">DurableObjectNamespace</span><span class="hl-1">;</span><br/><span class="hl-1">	</span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-1">: </span><span class="hl-8">D1Database</span><span class="hl-1">;</span><br/><span class="hl-1">	</span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-1">: </span><span class="hl-8">D1Database</span><span class="hl-1">;</span><br/><span class="hl-1">	</span><span class="hl-2">&#39;db-central&#39;</span><span class="hl-1">: </span><span class="hl-8">D1Database</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-4">export</span><span class="hl-1"> </span><span class="hl-4">default</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-5">request</span><span class="hl-1">: </span><span class="hl-8">Request</span><span class="hl-1">, </span><span class="hl-5">env</span><span class="hl-1">: </span><span class="hl-8">Env</span><span class="hl-1">): </span><span class="hl-8">Promise</span><span class="hl-1">&lt;</span><span class="hl-8">Response</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">		</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">collegedb</span><span class="hl-1">(</span><br/><span class="hl-1">			{</span><br/><span class="hl-1">				</span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">				</span><span class="hl-5">coordinator:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">, </span><span class="hl-3">// Optional: only needed for round-robin</span><br/><span class="hl-1">				</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1">, </span><span class="hl-3">// or &#39;round-robin&#39;, &#39;random&#39;, &#39;location&#39;</span><br/><span class="hl-1">				</span><span class="hl-5">shards:</span><span class="hl-1"> {</span><br/><span class="hl-1">					</span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">[</span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-1">],</span><br/><span class="hl-1">					</span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">[</span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-1">],</span><br/><span class="hl-1">					</span><span class="hl-2">&#39;db-central&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">[</span><span class="hl-2">&#39;db-central&#39;</span><span class="hl-1">]</span><br/><span class="hl-1">				}</span><br/><span class="hl-1">			},</span><br/><span class="hl-1">			</span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">				</span><span class="hl-3">// Your application logic here</span><br/><span class="hl-1">				</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">url</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">URL</span><span class="hl-1">(</span><span class="hl-5">request</span><span class="hl-1">.</span><span class="hl-5">url</span><span class="hl-1">);</span><br/><br/><span class="hl-1">				</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">url</span><span class="hl-1">.</span><span class="hl-5">pathname</span><span class="hl-1"> === </span><span class="hl-2">&#39;/user&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">					</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">userId</span><span class="hl-1"> = </span><span class="hl-5">url</span><span class="hl-1">.</span><span class="hl-5">searchParams</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-2">&#39;id&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">					</span><span class="hl-4">if</span><span class="hl-1"> (!</span><span class="hl-5">userId</span><span class="hl-1">) {</span><br/><span class="hl-1">						</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Response</span><span class="hl-1">(</span><span class="hl-2">&#39;Missing user ID&#39;</span><span class="hl-1">, { </span><span class="hl-5">status:</span><span class="hl-1"> </span><span class="hl-9">400</span><span class="hl-1"> });</span><br/><span class="hl-1">					}</span><br/><br/><span class="hl-1">					</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">user</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">first</span><span class="hl-1">(</span><span class="hl-5">userId</span><span class="hl-1">, </span><span class="hl-2">&#39;SELECT * FROM users WHERE id = ?&#39;</span><span class="hl-1">, [</span><span class="hl-5">userId</span><span class="hl-1">]);</span><br/><span class="hl-1">					</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-5">Response</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">(</span><span class="hl-5">user</span><span class="hl-1">);</span><br/><span class="hl-1">				}</span><br/><br/><span class="hl-1">				</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Response</span><span class="hl-1">(</span><span class="hl-2">&#39;CollegeDB API&#39;</span><span class="hl-1">, { </span><span class="hl-5">status:</span><span class="hl-1"> </span><span class="hl-9">200</span><span class="hl-1"> });</span><br/><span class="hl-1">			}</span><br/><span class="hl-1">		);</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<h3 id="4-deploy" class="tsd-anchor-link">4. Deploy<a href="#4-deploy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="bash"><span class="hl-3"># Deploy to Cloudflare Workers</span><br/><span class="hl-0">wrangler</span><span class="hl-1"> </span><span class="hl-2">deploy</span><br/><br/><span class="hl-3"># Deploy with environment</span><br/><span class="hl-0">wrangler</span><span class="hl-1"> </span><span class="hl-2">deploy</span><span class="hl-1"> </span><span class="hl-7">--env</span><span class="hl-1"> </span><span class="hl-2">production</span>
</code><button type="button">Copy</button></pre>

<h2 id="📊-monitoring-and-maintenance" class="tsd-anchor-link">📊 Monitoring and Maintenance<a href="#📊-monitoring-and-maintenance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="shard-statistics" class="tsd-anchor-link">Shard Statistics<a href="#shard-statistics" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><h4 id="using-collegedb-functions" class="tsd-anchor-link">Using CollegeDB Functions<a href="#using-collegedb-functions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">getShardStats</span><span class="hl-1">, </span><span class="hl-5">listKnownShards</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Get detailed statistics</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">stats</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">getShardStats</span><span class="hl-1">();</span><br/><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-5">stats</span><span class="hl-1">);</span><br/><span class="hl-3">// [</span><br/><span class="hl-3">//   { binding: &#39;db-east&#39;, count: 1542 },</span><br/><span class="hl-3">//   { binding: &#39;db-west&#39;, count: 1458 }</span><br/><span class="hl-3">// ]</span><br/><br/><span class="hl-3">// List available shards</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">shards</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">listKnownShards</span><span class="hl-1">();</span><br/><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-5">shards</span><span class="hl-1">); </span><span class="hl-3">// [&#39;db-east&#39;, &#39;db-west&#39;]</span>
</code><button type="button">Copy</button></pre>

<h4 id="using-shardcoordinator-directly" class="tsd-anchor-link">Using ShardCoordinator Directly<a href="#using-shardcoordinator-directly" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-3">// Get coordinator instance</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinatorId</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">idFromName</span><span class="hl-1">(</span><span class="hl-2">&#39;default&#39;</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinator</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-5">coordinatorId</span><span class="hl-1">);</span><br/><br/><span class="hl-3">// Get real-time shard statistics</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">statsResponse</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/stats&#39;</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">detailedStats</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">statsResponse</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">();</span><br/><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-5">detailedStats</span><span class="hl-1">);</span><br/><span class="hl-3">/* Returns:</span><br/><span class="hl-3">[</span><br/><span class="hl-3">  {</span><br/><span class="hl-3">    &quot;binding&quot;: &quot;db-east&quot;,</span><br/><span class="hl-3">    &quot;count&quot;: 1542,</span><br/><span class="hl-3">    &quot;lastUpdated&quot;: 1672531200000</span><br/><span class="hl-3">  },</span><br/><span class="hl-3">  {</span><br/><span class="hl-3">    &quot;binding&quot;: &quot;db-west&quot;,</span><br/><span class="hl-3">    &quot;count&quot;: 1458,</span><br/><span class="hl-3">    &quot;lastUpdated&quot;: 1672531205000</span><br/><span class="hl-3">  }</span><br/><span class="hl-3">]</span><br/><span class="hl-3">*/</span><br/><br/><span class="hl-3">// List registered shards</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">shardsResponse</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/shards&#39;</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">allShards</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">shardsResponse</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">();</span><br/><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-5">allShards</span><span class="hl-1">); </span><span class="hl-3">// [&#39;db-east&#39;, &#39;db-west&#39;, &#39;db-central&#39;]</span>
</code><button type="button">Copy</button></pre>

<h4 id="advanced-monitoring-dashboard" class="tsd-anchor-link">Advanced Monitoring Dashboard<a href="#advanced-monitoring-dashboard" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">createMonitoringDashboard</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">: </span><span class="hl-8">Env</span><span class="hl-1">) {</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinatorId</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">idFromName</span><span class="hl-1">(</span><span class="hl-2">&#39;default&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinator</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-5">coordinatorId</span><span class="hl-1">);</span><br/><br/><span class="hl-1">	</span><span class="hl-3">// Get comprehensive metrics</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> [</span><span class="hl-6">shardsResponse</span><span class="hl-1">, </span><span class="hl-6">statsResponse</span><span class="hl-1">, </span><span class="hl-6">healthResponse</span><span class="hl-1">] = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-8">Promise</span><span class="hl-1">.</span><span class="hl-0">all</span><span class="hl-1">([</span><br/><span class="hl-1">		</span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/shards&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">		</span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/stats&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">		</span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/health&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">	]);</span><br/><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">shards</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">shardsResponse</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">();</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">stats</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">statsResponse</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">();</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">isHealthy</span><span class="hl-1"> = </span><span class="hl-5">healthResponse</span><span class="hl-1">.</span><span class="hl-5">ok</span><span class="hl-1">;</span><br/><br/><span class="hl-1">	</span><span class="hl-3">// Calculate distribution metrics</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">totalKeys</span><span class="hl-1"> = </span><span class="hl-5">stats</span><span class="hl-1">.</span><span class="hl-0">reduce</span><span class="hl-1">((</span><span class="hl-5">sum</span><span class="hl-1">: </span><span class="hl-8">number</span><span class="hl-1">, </span><span class="hl-5">shard</span><span class="hl-1">: </span><span class="hl-8">any</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-5">sum</span><span class="hl-1"> + </span><span class="hl-5">shard</span><span class="hl-1">.</span><span class="hl-5">count</span><span class="hl-1">, </span><span class="hl-9">0</span><span class="hl-1">);</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">avgKeysPerShard</span><span class="hl-1"> = </span><span class="hl-5">totalKeys</span><span class="hl-1"> / </span><span class="hl-5">stats</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1">;</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">maxKeys</span><span class="hl-1"> = </span><span class="hl-5">Math</span><span class="hl-1">.</span><span class="hl-0">max</span><span class="hl-1">(...</span><span class="hl-5">stats</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">((</span><span class="hl-5">s</span><span class="hl-1">: </span><span class="hl-8">any</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-5">s</span><span class="hl-1">.</span><span class="hl-5">count</span><span class="hl-1">));</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">minKeys</span><span class="hl-1"> = </span><span class="hl-5">Math</span><span class="hl-1">.</span><span class="hl-0">min</span><span class="hl-1">(...</span><span class="hl-5">stats</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">((</span><span class="hl-5">s</span><span class="hl-1">: </span><span class="hl-8">any</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-5">s</span><span class="hl-1">.</span><span class="hl-5">count</span><span class="hl-1">));</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">distributionRatio</span><span class="hl-1"> = </span><span class="hl-5">maxKeys</span><span class="hl-1"> / (</span><span class="hl-5">minKeys</span><span class="hl-1"> || </span><span class="hl-9">1</span><span class="hl-1">);</span><br/><br/><span class="hl-1">	</span><span class="hl-3">// Check for stale statistics (&gt;5 minutes)</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">now</span><span class="hl-1"> = </span><span class="hl-5">Date</span><span class="hl-1">.</span><span class="hl-0">now</span><span class="hl-1">();</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">staleThreshold</span><span class="hl-1"> = </span><span class="hl-9">5</span><span class="hl-1"> * </span><span class="hl-9">60</span><span class="hl-1"> * </span><span class="hl-9">1000</span><span class="hl-1">; </span><span class="hl-3">// 5 minutes</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">staleShards</span><span class="hl-1"> = </span><span class="hl-5">stats</span><span class="hl-1">.</span><span class="hl-0">filter</span><span class="hl-1">((</span><span class="hl-5">shard</span><span class="hl-1">: </span><span class="hl-8">any</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-5">now</span><span class="hl-1"> - </span><span class="hl-5">shard</span><span class="hl-1">.</span><span class="hl-5">lastUpdated</span><span class="hl-1"> &gt; </span><span class="hl-5">staleThreshold</span><span class="hl-1">);</span><br/><br/><span class="hl-1">	</span><span class="hl-4">return</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-5">healthy:</span><span class="hl-1"> </span><span class="hl-5">isHealthy</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">totalShards:</span><span class="hl-1"> </span><span class="hl-5">shards</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">totalKeys</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">avgKeysPerShard:</span><span class="hl-1"> </span><span class="hl-5">Math</span><span class="hl-1">.</span><span class="hl-0">round</span><span class="hl-1">(</span><span class="hl-5">avgKeysPerShard</span><span class="hl-1">),</span><br/><span class="hl-1">		</span><span class="hl-5">distributionRatio:</span><span class="hl-1"> </span><span class="hl-5">Math</span><span class="hl-1">.</span><span class="hl-0">round</span><span class="hl-1">(</span><span class="hl-5">distributionRatio</span><span class="hl-1"> * </span><span class="hl-9">100</span><span class="hl-1">) / </span><span class="hl-9">100</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">isBalanced:</span><span class="hl-1"> </span><span class="hl-5">distributionRatio</span><span class="hl-1"> &lt; </span><span class="hl-9">1.5</span><span class="hl-1">, </span><span class="hl-3">// Less than 50% difference</span><br/><span class="hl-1">		</span><span class="hl-5">staleShards:</span><span class="hl-1"> </span><span class="hl-5">staleShards</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">shardDetails:</span><span class="hl-1"> </span><span class="hl-5">stats</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">((</span><span class="hl-5">shard</span><span class="hl-1">: </span><span class="hl-8">any</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">			...</span><span class="hl-5">shard</span><span class="hl-1">,</span><br/><span class="hl-1">			</span><span class="hl-5">loadPercentage:</span><span class="hl-1"> </span><span class="hl-5">Math</span><span class="hl-1">.</span><span class="hl-0">round</span><span class="hl-1">((</span><span class="hl-5">shard</span><span class="hl-1">.</span><span class="hl-5">count</span><span class="hl-1"> / </span><span class="hl-5">totalKeys</span><span class="hl-1">) * </span><span class="hl-9">100</span><span class="hl-1">),</span><br/><span class="hl-1">			</span><span class="hl-5">isStale:</span><span class="hl-1"> </span><span class="hl-5">now</span><span class="hl-1"> - </span><span class="hl-5">shard</span><span class="hl-1">.</span><span class="hl-5">lastUpdated</span><span class="hl-1"> &gt; </span><span class="hl-5">staleThreshold</span><br/><span class="hl-1">		}))</span><br/><span class="hl-1">	};</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-3">// Usage in monitoring endpoint</span><br/><span class="hl-4">export</span><span class="hl-1"> </span><span class="hl-4">default</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-5">request</span><span class="hl-1">: </span><span class="hl-8">Request</span><span class="hl-1">, </span><span class="hl-5">env</span><span class="hl-1">: </span><span class="hl-8">Env</span><span class="hl-1">) {</span><br/><span class="hl-1">		</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">URL</span><span class="hl-1">(</span><span class="hl-5">request</span><span class="hl-1">.</span><span class="hl-5">url</span><span class="hl-1">).</span><span class="hl-5">pathname</span><span class="hl-1"> === </span><span class="hl-2">&#39;/monitor&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">			</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">dashboard</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">createMonitoringDashboard</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">);</span><br/><span class="hl-1">			</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-5">Response</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">(</span><span class="hl-5">dashboard</span><span class="hl-1">);</span><br/><span class="hl-1">		}</span><br/><span class="hl-1">		</span><span class="hl-3">// ... rest of your app</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<h3 id="shard-rebalancing" class="tsd-anchor-link">Shard Rebalancing<a href="#shard-rebalancing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">reassignShard</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Move a primary key to a different shard</span><br/><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">reassignShard</span><span class="hl-1">(</span><span class="hl-2">&#39;user-123&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h3 id="health-monitoring" class="tsd-anchor-link">Health Monitoring<a href="#health-monitoring" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Monitor your CollegeDB deployment by tracking:</p>
<ul>
<li><strong>Shard distribution balance</strong></li>
<li><strong>Query latency per shard</strong></li>
<li><strong>Error rates and failed queries</strong></li>
<li><strong>KV operation metrics</strong></li>
<li><strong>ShardCoordinator health and availability</strong></li>
</ul>
<h4 id="automated-health-checks" class="tsd-anchor-link">Automated Health Checks<a href="#automated-health-checks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">performHealthChecks</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">: </span><span class="hl-8">Env</span><span class="hl-1">): </span><span class="hl-8">Promise</span><span class="hl-1">&lt;</span><span class="hl-8">HealthReport</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">results</span><span class="hl-1">: </span><span class="hl-8">HealthReport</span><span class="hl-1"> = {</span><br/><span class="hl-1">		</span><span class="hl-5">overall:</span><span class="hl-1"> </span><span class="hl-2">&#39;healthy&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">timestamp:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">().</span><span class="hl-0">toISOString</span><span class="hl-1">(),</span><br/><span class="hl-1">		</span><span class="hl-5">checks:</span><span class="hl-1"> {}</span><br/><span class="hl-1">	};</span><br/><br/><span class="hl-1">	</span><span class="hl-3">// 1. Test KV availability</span><br/><span class="hl-1">	</span><span class="hl-4">try</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">.</span><span class="hl-0">put</span><span class="hl-1">(</span><span class="hl-2">&#39;health-check&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;ok&#39;</span><span class="hl-1">, { </span><span class="hl-5">expirationTtl:</span><span class="hl-1"> </span><span class="hl-9">60</span><span class="hl-1"> });</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">kvTest</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-2">&#39;health-check&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">		</span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">checks</span><span class="hl-1">.</span><span class="hl-5">kv</span><span class="hl-1"> = </span><span class="hl-5">kvTest</span><span class="hl-1"> === </span><span class="hl-2">&#39;ok&#39;</span><span class="hl-1"> ? </span><span class="hl-2">&#39;healthy&#39;</span><span class="hl-1"> : </span><span class="hl-2">&#39;degraded&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">	} </span><span class="hl-4">catch</span><span class="hl-1"> (</span><span class="hl-5">error</span><span class="hl-1">) {</span><br/><span class="hl-1">		</span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">checks</span><span class="hl-1">.</span><span class="hl-5">kv</span><span class="hl-1"> = </span><span class="hl-2">&#39;unhealthy&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">		</span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">overall</span><span class="hl-1"> = </span><span class="hl-2">&#39;unhealthy&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">	}</span><br/><br/><span class="hl-1">	</span><span class="hl-3">// 2. Test ShardCoordinator availability</span><br/><span class="hl-1">	</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">) {</span><br/><span class="hl-1">		</span><span class="hl-4">try</span><span class="hl-1"> {</span><br/><span class="hl-1">			</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinatorId</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">idFromName</span><span class="hl-1">(</span><span class="hl-2">&#39;default&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">			</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinator</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-5">coordinatorId</span><span class="hl-1">);</span><br/><span class="hl-1">			</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">healthResponse</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/health&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">			</span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">checks</span><span class="hl-1">.</span><span class="hl-5">coordinator</span><span class="hl-1"> = </span><span class="hl-5">healthResponse</span><span class="hl-1">.</span><span class="hl-5">ok</span><span class="hl-1"> ? </span><span class="hl-2">&#39;healthy&#39;</span><span class="hl-1"> : </span><span class="hl-2">&#39;unhealthy&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-1">			</span><span class="hl-4">if</span><span class="hl-1"> (!</span><span class="hl-5">healthResponse</span><span class="hl-1">.</span><span class="hl-5">ok</span><span class="hl-1">) {</span><br/><span class="hl-1">				</span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">overall</span><span class="hl-1"> = </span><span class="hl-2">&#39;degraded&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">			}</span><br/><span class="hl-1">		} </span><span class="hl-4">catch</span><span class="hl-1"> (</span><span class="hl-5">error</span><span class="hl-1">) {</span><br/><span class="hl-1">			</span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">checks</span><span class="hl-1">.</span><span class="hl-5">coordinator</span><span class="hl-1"> = </span><span class="hl-2">&#39;unhealthy&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">			</span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">overall</span><span class="hl-1"> = </span><span class="hl-2">&#39;degraded&#39;</span><span class="hl-1">; </span><span class="hl-3">// Can fallback to hash allocation</span><br/><span class="hl-1">		}</span><br/><span class="hl-1">	}</span><br/><br/><span class="hl-1">	</span><span class="hl-3">// 3. Test each D1 shard</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">shardTests</span><span class="hl-1"> = </span><span class="hl-5">Object</span><span class="hl-1">.</span><span class="hl-0">entries</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">)</span><br/><span class="hl-1">		.</span><span class="hl-0">filter</span><span class="hl-1">(([</span><span class="hl-5">key</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-5">key</span><span class="hl-1">.</span><span class="hl-0">startsWith</span><span class="hl-1">(</span><span class="hl-2">&#39;db-&#39;</span><span class="hl-1">))</span><br/><span class="hl-1">		.</span><span class="hl-0">map</span><span class="hl-1">(</span><span class="hl-7">async</span><span class="hl-1"> ([</span><span class="hl-5">shardName</span><span class="hl-1">, </span><span class="hl-5">db</span><span class="hl-1">]: [</span><span class="hl-8">string</span><span class="hl-1">, </span><span class="hl-8">any</span><span class="hl-1">]) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">			</span><span class="hl-4">try</span><span class="hl-1"> {</span><br/><span class="hl-1">				</span><span class="hl-3">// Simple query to test connectivity</span><br/><span class="hl-1">				</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">db</span><span class="hl-1">.</span><span class="hl-0">prepare</span><span class="hl-1">(</span><span class="hl-2">&#39;SELECT 1 as test&#39;</span><span class="hl-1">).</span><span class="hl-0">first</span><span class="hl-1">();</span><br/><span class="hl-1">				</span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">checks</span><span class="hl-1">[</span><span class="hl-5">shardName</span><span class="hl-1">] = </span><span class="hl-2">&#39;healthy&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">			} </span><span class="hl-4">catch</span><span class="hl-1"> (</span><span class="hl-5">error</span><span class="hl-1">) {</span><br/><span class="hl-1">				</span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">checks</span><span class="hl-1">[</span><span class="hl-5">shardName</span><span class="hl-1">] = </span><span class="hl-2">&#39;unhealthy&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">				</span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">overall</span><span class="hl-1"> = </span><span class="hl-2">&#39;unhealthy&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">			}</span><br/><span class="hl-1">		});</span><br/><br/><span class="hl-1">	</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-8">Promise</span><span class="hl-1">.</span><span class="hl-0">all</span><span class="hl-1">(</span><span class="hl-5">shardTests</span><span class="hl-1">);</span><br/><br/><span class="hl-1">	</span><span class="hl-3">// 4. Check shard distribution balance</span><br/><span class="hl-1">	</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">checks</span><span class="hl-1">.</span><span class="hl-5">coordinator</span><span class="hl-1"> === </span><span class="hl-2">&#39;healthy&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">		</span><span class="hl-4">try</span><span class="hl-1"> {</span><br/><span class="hl-1">			</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinatorId</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">idFromName</span><span class="hl-1">(</span><span class="hl-2">&#39;default&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">			</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinator</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-5">coordinatorId</span><span class="hl-1">);</span><br/><span class="hl-1">			</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">statsResponse</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/stats&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">			</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">stats</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">statsResponse</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">();</span><br/><br/><span class="hl-1">			</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">totalKeys</span><span class="hl-1"> = </span><span class="hl-5">stats</span><span class="hl-1">.</span><span class="hl-0">reduce</span><span class="hl-1">((</span><span class="hl-5">sum</span><span class="hl-1">: </span><span class="hl-8">number</span><span class="hl-1">, </span><span class="hl-5">shard</span><span class="hl-1">: </span><span class="hl-8">any</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-5">sum</span><span class="hl-1"> + </span><span class="hl-5">shard</span><span class="hl-1">.</span><span class="hl-5">count</span><span class="hl-1">, </span><span class="hl-9">0</span><span class="hl-1">);</span><br/><span class="hl-1">			</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">totalKeys</span><span class="hl-1"> &gt; </span><span class="hl-9">0</span><span class="hl-1">) {</span><br/><span class="hl-1">				</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">avgKeys</span><span class="hl-1"> = </span><span class="hl-5">totalKeys</span><span class="hl-1"> / </span><span class="hl-5">stats</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1">;</span><br/><span class="hl-1">				</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">maxKeys</span><span class="hl-1"> = </span><span class="hl-5">Math</span><span class="hl-1">.</span><span class="hl-0">max</span><span class="hl-1">(...</span><span class="hl-5">stats</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">((</span><span class="hl-5">s</span><span class="hl-1">: </span><span class="hl-8">any</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-5">s</span><span class="hl-1">.</span><span class="hl-5">count</span><span class="hl-1">));</span><br/><span class="hl-1">				</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">distributionRatio</span><span class="hl-1"> = </span><span class="hl-5">maxKeys</span><span class="hl-1"> / </span><span class="hl-5">avgKeys</span><span class="hl-1">;</span><br/><br/><span class="hl-1">				</span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">checks</span><span class="hl-1">.</span><span class="hl-5">distribution</span><span class="hl-1"> = </span><span class="hl-5">distributionRatio</span><span class="hl-1"> &lt; </span><span class="hl-9">2</span><span class="hl-1"> ? </span><span class="hl-2">&#39;healthy&#39;</span><span class="hl-1"> : </span><span class="hl-2">&#39;degraded&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">				</span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">distributionRatio</span><span class="hl-1"> = </span><span class="hl-5">distributionRatio</span><span class="hl-1">;</span><br/><br/><span class="hl-1">				</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">distributionRatio</span><span class="hl-1"> &gt;= </span><span class="hl-9">3</span><span class="hl-1"> &amp;&amp; </span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">overall</span><span class="hl-1"> === </span><span class="hl-2">&#39;healthy&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">					</span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">overall</span><span class="hl-1"> = </span><span class="hl-2">&#39;degraded&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">				}</span><br/><span class="hl-1">			}</span><br/><span class="hl-1">		} </span><span class="hl-4">catch</span><span class="hl-1"> (</span><span class="hl-5">error</span><span class="hl-1">) {</span><br/><span class="hl-1">			</span><span class="hl-5">results</span><span class="hl-1">.</span><span class="hl-5">checks</span><span class="hl-1">.</span><span class="hl-5">distribution</span><span class="hl-1"> = </span><span class="hl-2">&#39;unknown&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">		}</span><br/><span class="hl-1">	}</span><br/><br/><span class="hl-1">	</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-5">results</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-7">interface</span><span class="hl-1"> </span><span class="hl-8">HealthReport</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-5">overall</span><span class="hl-1">: </span><span class="hl-2">&#39;healthy&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;degraded&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;unhealthy&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">	</span><span class="hl-5">timestamp</span><span class="hl-1">: </span><span class="hl-8">string</span><span class="hl-1">;</span><br/><span class="hl-1">	</span><span class="hl-5">checks</span><span class="hl-1">: </span><span class="hl-8">Record</span><span class="hl-1">&lt;</span><span class="hl-8">string</span><span class="hl-1">, </span><span class="hl-2">&#39;healthy&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;degraded&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;unhealthy&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;unknown&#39;</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">	</span><span class="hl-5">distributionRatio</span><span class="hl-1">?: </span><span class="hl-8">number</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-3">// Health endpoint example</span><br/><span class="hl-4">export</span><span class="hl-1"> </span><span class="hl-4">default</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-5">request</span><span class="hl-1">: </span><span class="hl-8">Request</span><span class="hl-1">, </span><span class="hl-5">env</span><span class="hl-1">: </span><span class="hl-8">Env</span><span class="hl-1">) {</span><br/><span class="hl-1">		</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">URL</span><span class="hl-1">(</span><span class="hl-5">request</span><span class="hl-1">.</span><span class="hl-5">url</span><span class="hl-1">).</span><span class="hl-5">pathname</span><span class="hl-1"> === </span><span class="hl-2">&#39;/health&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">			</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">health</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">performHealthChecks</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">);</span><br/><span class="hl-1">			</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">statusCode</span><span class="hl-1"> = </span><span class="hl-5">health</span><span class="hl-1">.</span><span class="hl-5">overall</span><span class="hl-1"> === </span><span class="hl-2">&#39;healthy&#39;</span><span class="hl-1"> ? </span><span class="hl-9">200</span><span class="hl-1"> : </span><span class="hl-5">health</span><span class="hl-1">.</span><span class="hl-5">overall</span><span class="hl-1"> === </span><span class="hl-2">&#39;degraded&#39;</span><span class="hl-1"> ? </span><span class="hl-9">206</span><span class="hl-1"> : </span><span class="hl-9">503</span><span class="hl-1">;</span><br/><span class="hl-1">			</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-5">Response</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">(</span><span class="hl-5">health</span><span class="hl-1">, { </span><span class="hl-5">status:</span><span class="hl-1"> </span><span class="hl-5">statusCode</span><span class="hl-1"> });</span><br/><span class="hl-1">		}</span><br/><span class="hl-1">		</span><span class="hl-3">// ... rest of your app</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<h4 id="alerting-and-monitoring-integration" class="tsd-anchor-link">Alerting and Monitoring Integration<a href="#alerting-and-monitoring-integration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-3">// Integration with external monitoring services</span><br/><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">sendAlert</span><span class="hl-1">(</span><span class="hl-5">severity</span><span class="hl-1">: </span><span class="hl-2">&#39;warning&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;critical&#39;</span><span class="hl-1">, </span><span class="hl-5">message</span><span class="hl-1">: </span><span class="hl-8">string</span><span class="hl-1">, </span><span class="hl-5">env</span><span class="hl-1">: </span><span class="hl-8">Env</span><span class="hl-1">) {</span><br/><span class="hl-1">	</span><span class="hl-3">// Example: Slack webhook</span><br/><span class="hl-1">	</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">SLACK_WEBHOOK_URL</span><span class="hl-1">) {</span><br/><span class="hl-1">		</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">SLACK_WEBHOOK_URL</span><span class="hl-1">, {</span><br/><span class="hl-1">			</span><span class="hl-5">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;POST&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">			</span><span class="hl-5">headers:</span><span class="hl-1"> { </span><span class="hl-2">&#39;Content-Type&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-2">&#39;application/json&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">			</span><span class="hl-5">body:</span><span class="hl-1"> </span><span class="hl-6">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({</span><br/><span class="hl-1">				</span><span class="hl-5">text:</span><span class="hl-1"> </span><span class="hl-2">`🚨 CollegeDB </span><span class="hl-7">${</span><span class="hl-5">severity</span><span class="hl-10">.</span><span class="hl-0">toUpperCase</span><span class="hl-10">()</span><span class="hl-7">}</span><span class="hl-2">: </span><span class="hl-7">${</span><span class="hl-5">message</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">,</span><br/><span class="hl-1">				</span><span class="hl-5">username:</span><span class="hl-1"> </span><span class="hl-2">&#39;CollegeDB Monitor&#39;</span><br/><span class="hl-1">			})</span><br/><span class="hl-1">		});</span><br/><span class="hl-1">	}</span><br/><br/><span class="hl-1">	</span><span class="hl-3">// Example: Custom webhook</span><br/><span class="hl-1">	</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">MONITORING_WEBHOOK_URL</span><span class="hl-1">) {</span><br/><span class="hl-1">		</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">MONITORING_WEBHOOK_URL</span><span class="hl-1">, {</span><br/><span class="hl-1">			</span><span class="hl-5">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;POST&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">			</span><span class="hl-5">headers:</span><span class="hl-1"> { </span><span class="hl-2">&#39;Content-Type&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-2">&#39;application/json&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">			</span><span class="hl-5">body:</span><span class="hl-1"> </span><span class="hl-6">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({</span><br/><span class="hl-1">				</span><span class="hl-5">service:</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">				</span><span class="hl-5">severity</span><span class="hl-1">,</span><br/><span class="hl-1">				</span><span class="hl-5">message</span><span class="hl-1">,</span><br/><span class="hl-1">				</span><span class="hl-5">timestamp:</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">().</span><span class="hl-0">toISOString</span><span class="hl-1">()</span><br/><span class="hl-1">			})</span><br/><span class="hl-1">		});</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-3">// Scheduled monitoring (using Cron Triggers)</span><br/><span class="hl-4">export</span><span class="hl-1"> </span><span class="hl-4">default</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">scheduled</span><span class="hl-1">(</span><span class="hl-5">event</span><span class="hl-1">: </span><span class="hl-8">ScheduledEvent</span><span class="hl-1">, </span><span class="hl-5">env</span><span class="hl-1">: </span><span class="hl-8">Env</span><span class="hl-1">, </span><span class="hl-5">ctx</span><span class="hl-1">: </span><span class="hl-8">ExecutionContext</span><span class="hl-1">): </span><span class="hl-8">Promise</span><span class="hl-1">&lt;</span><span class="hl-8">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">health</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">performHealthChecks</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">);</span><br/><br/><span class="hl-1">		</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">health</span><span class="hl-1">.</span><span class="hl-5">overall</span><span class="hl-1"> === </span><span class="hl-2">&#39;unhealthy&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">			</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">sendAlert</span><span class="hl-1">(</span><span class="hl-2">&#39;critical&#39;</span><span class="hl-1">, </span><span class="hl-2">`System unhealthy: </span><span class="hl-7">${</span><span class="hl-6">JSON</span><span class="hl-10">.</span><span class="hl-0">stringify</span><span class="hl-10">(</span><span class="hl-5">health</span><span class="hl-10">.</span><span class="hl-5">checks</span><span class="hl-10">)</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">, </span><span class="hl-5">env</span><span class="hl-1">);</span><br/><span class="hl-1">		} </span><span class="hl-4">else</span><span class="hl-1"> </span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">health</span><span class="hl-1">.</span><span class="hl-5">overall</span><span class="hl-1"> === </span><span class="hl-2">&#39;degraded&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">			</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">sendAlert</span><span class="hl-1">(</span><span class="hl-2">&#39;warning&#39;</span><span class="hl-1">, </span><span class="hl-2">`System degraded: </span><span class="hl-7">${</span><span class="hl-6">JSON</span><span class="hl-10">.</span><span class="hl-0">stringify</span><span class="hl-10">(</span><span class="hl-5">health</span><span class="hl-10">.</span><span class="hl-5">checks</span><span class="hl-10">)</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">, </span><span class="hl-5">env</span><span class="hl-1">);</span><br/><span class="hl-1">		}</span><br/><br/><span class="hl-1">		</span><span class="hl-3">// Check for severe shard imbalance</span><br/><span class="hl-1">		</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">health</span><span class="hl-1">.</span><span class="hl-5">distributionRatio</span><span class="hl-1"> &amp;&amp; </span><span class="hl-5">health</span><span class="hl-1">.</span><span class="hl-5">distributionRatio</span><span class="hl-1"> &gt; </span><span class="hl-9">5</span><span class="hl-1">) {</span><br/><span class="hl-1">			</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">sendAlert</span><span class="hl-1">(</span><span class="hl-2">&#39;warning&#39;</span><span class="hl-1">, </span><span class="hl-2">`Severe shard imbalance detected: </span><span class="hl-7">${</span><span class="hl-5">health</span><span class="hl-10">.</span><span class="hl-5">distributionRatio</span><span class="hl-7">}</span><span class="hl-2">x difference`</span><span class="hl-1">, </span><span class="hl-5">env</span><span class="hl-1">);</span><br/><span class="hl-1">		}</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<h2 id="⚙️-performance-analysis" class="tsd-anchor-link">⚙️ Performance Analysis<a href="#⚙️-performance-analysis" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="scaling-performance-comparison" class="tsd-anchor-link">Scaling Performance Comparison<a href="#scaling-performance-comparison" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>CollegeDB provides significant performance improvements through horizontal scaling. Here are mathematical estimates comparing single D1 database vs CollegeDB with different shard counts:</p>
<h4 id="query-performance" class="tsd-anchor-link">Query Performance<a href="#query-performance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p><em>SELECT, VALUES, TABLE, PRAGMA, ...</em></p>
<table>
<thead>
<tr>
<th>Configuration</th>
<th>Query Latency*</th>
<th>Concurrent Queries</th>
<th>Throughput Gain</th>
</tr>
</thead>
<tbody>
<tr>
<td>Single D1</td>
<td>~50-80ms</td>
<td>Limited by D1 limits</td>
<td>1x (baseline)</td>
</tr>
<tr>
<td>CollegeDB (10 shards)</td>
<td>~55-85ms</td>
<td>10x parallel capacity</td>
<td>~8-9x</td>
</tr>
<tr>
<td>CollegeDB (100 shards)</td>
<td>~60-90ms</td>
<td>100x parallel capacity</td>
<td>~75-80x</td>
</tr>
<tr>
<td>CollegeDB (1000 shards)</td>
<td>~65-95ms</td>
<td>1000x parallel capacity</td>
<td>~650-700x</td>
</tr>
</tbody>
</table>
<p>*Includes KV lookup overhead (~5-15ms) and SHA-256 hashing overhead (~1-3ms when <code>hashShardMappings: true</code>)</p>
<h4 id="write-performance" class="tsd-anchor-link">Write Performance<a href="#write-performance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p><em>INSERT, UPDATE, DELETE, ...</em></p>
<table>
<thead>
<tr>
<th>Configuration</th>
<th>Write Latency*</th>
<th>Concurrent Writes</th>
<th>Throughput Gain</th>
</tr>
</thead>
<tbody>
<tr>
<td>Single D1</td>
<td>~80-120ms</td>
<td>~50 writes/sec</td>
<td>1x (baseline)</td>
</tr>
<tr>
<td>CollegeDB (10 shards)</td>
<td>~90-135ms</td>
<td>~450 writes/sec</td>
<td>~9x</td>
</tr>
<tr>
<td>CollegeDB (100 shards)</td>
<td>~95-145ms</td>
<td>~4,200 writes/sec</td>
<td>~84x</td>
</tr>
<tr>
<td>CollegeDB (1000 shards)</td>
<td>~105-160ms</td>
<td>~35,000 writes/sec</td>
<td>~700x</td>
</tr>
</tbody>
</table>
<p>*Includes KV mapping creation/update overhead (~10-25ms) and SHA-256 hashing overhead (~1-3ms when <code>hashShardMappings: true</code>)</p>
<h3 id="strategy-specific-performance" class="tsd-anchor-link">Strategy-Specific Performance<a href="#strategy-specific-performance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><h4 id="hash-strategy" class="tsd-anchor-link">Hash Strategy<a href="#hash-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><strong>Best for</strong>: Consistent performance, even data distribution</li>
<li><strong>Latency</strong>: Lowest overhead (no coordinator calls, ~1-3ms SHA-256 hashing when enabled)</li>
<li><strong>Throughput</strong>: Optimal for high-volume scenarios</li>
</ul>
<table>
<thead>
<tr>
<th>Shards</th>
<th>Avg Latency</th>
<th>Distribution Quality</th>
<th>Coordinator Dependency</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>+5ms</td>
<td>Excellent</td>
<td>None</td>
</tr>
<tr>
<td>100</td>
<td>+5ms</td>
<td>Excellent</td>
<td>None</td>
</tr>
<tr>
<td>1000</td>
<td>+5ms</td>
<td>Excellent</td>
<td>None</td>
</tr>
</tbody>
</table>
<h4 id="round-robin-strategy" class="tsd-anchor-link">Round-Robin Strategy<a href="#round-robin-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><strong>Best for</strong>: Guaranteed even distribution</li>
<li><strong>Latency</strong>: Requires coordinator communication</li>
<li><strong>Throughput</strong>: Good, limited by coordinator</li>
</ul>
<table>
<thead>
<tr>
<th>Shards</th>
<th>Avg Latency</th>
<th>Distribution Quality</th>
<th>Coordinator Dependency</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>+15ms</td>
<td>Perfect</td>
<td>High</td>
</tr>
<tr>
<td>100</td>
<td>+20ms</td>
<td>Perfect</td>
<td>High</td>
</tr>
<tr>
<td>1000</td>
<td>+25ms</td>
<td>Perfect</td>
<td>High</td>
</tr>
</tbody>
</table>
<h4 id="random-strategy" class="tsd-anchor-link">Random Strategy<a href="#random-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><strong>Best for</strong>: Simple setup, good distribution over time</li>
<li><strong>Latency</strong>: Low overhead</li>
<li><strong>Throughput</strong>: Good for medium-scale deployments</li>
</ul>
<table>
<thead>
<tr>
<th>Shards</th>
<th>Avg Latency</th>
<th>Distribution Quality</th>
<th>Coordinator Dependency</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>+3ms</td>
<td>Good</td>
<td>None</td>
</tr>
<tr>
<td>100</td>
<td>+3ms</td>
<td>Good</td>
<td>None</td>
</tr>
<tr>
<td>1000</td>
<td>+3ms</td>
<td>Fair</td>
<td>None</td>
</tr>
</tbody>
</table>
<h4 id="location-strategy" class="tsd-anchor-link">Location Strategy<a href="#location-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><strong>Best for</strong>: Geographic optimization, reduced latency</li>
<li><strong>Latency</strong>: Optimized by region proximity</li>
<li><strong>Throughput</strong>: Regional performance benefits</li>
</ul>
<table>
<thead>
<tr>
<th>Shards</th>
<th>Avg Latency</th>
<th>Geographic Benefit</th>
<th>Coordinator Dependency</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>+8ms</td>
<td>Excellent (-20-40ms)</td>
<td>Optional</td>
</tr>
<tr>
<td>100</td>
<td>+10ms</td>
<td>Excellent (-20-40ms)</td>
<td>Optional</td>
</tr>
<tr>
<td>1000</td>
<td>+12ms</td>
<td>Excellent (-20-40ms)</td>
<td>Optional</td>
</tr>
</tbody>
</table>
<h4 id="mixed-strategy" class="tsd-anchor-link">Mixed Strategy<a href="#mixed-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><strong>Best for</strong>: Optimizing both read and write performance independently</li>
<li><strong>Latency</strong>: Best of both strategies combined</li>
<li><strong>Throughput</strong>: Optimal for workloads with different read/write patterns</li>
</ul>
<p><strong>High-Performance Mix</strong>: <code>{ read: 'hash', write: 'location' }</code></p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Strategy</th>
<th>Latency Impact</th>
<th>Throughput Benefit</th>
<th>Geographic Benefit</th>
</tr>
</thead>
<tbody>
<tr>
<td>Reads</td>
<td>Hash</td>
<td>+5ms</td>
<td>Excellent</td>
<td>None</td>
</tr>
<tr>
<td>Writes</td>
<td>Location</td>
<td>+8ms (-20-40ms regional)</td>
<td>Good</td>
<td>Excellent (-20-40ms)</td>
</tr>
</tbody>
</table>
<p><strong>Balanced Mix</strong>: <code>{ read: 'location', write: 'hash' }</code></p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Strategy</th>
<th>Latency Impact</th>
<th>Throughput Benefit</th>
<th>Geographic Benefit</th>
</tr>
</thead>
<tbody>
<tr>
<td>Reads</td>
<td>Location</td>
<td>+8ms (-20-40ms regional)</td>
<td>Good</td>
<td>Excellent (-20-40ms)</td>
</tr>
<tr>
<td>Writes</td>
<td>Hash</td>
<td>+5ms</td>
<td>Excellent</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Enterprise Mix</strong>: <code>{ read: 'hash', write: 'round-robin' }</code></p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Strategy</th>
<th>Latency Impact</th>
<th>Distribution Quality</th>
<th>Coordinator Dependency</th>
</tr>
</thead>
<tbody>
<tr>
<td>Reads</td>
<td>Hash</td>
<td>+5ms</td>
<td>Excellent</td>
<td>None</td>
</tr>
<tr>
<td>Writes</td>
<td>Round-Robin</td>
<td>+15-25ms</td>
<td>Perfect</td>
<td>High</td>
</tr>
</tbody>
</table>
<h5 id="by-shard-count" class="tsd-anchor-link">By Shard Count<a href="#by-shard-count" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h5><p><strong>Hash + Location Mix</strong> (<code>{ read: 'hash', write: 'location' }</code>)</p>
<table>
<thead>
<tr>
<th>Shards</th>
<th>Read Latency</th>
<th>Write Latency</th>
<th>Combined Benefit</th>
<th>Best Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>+5ms</td>
<td>+8ms (-30ms regional)</td>
<td>~22ms net improvement</td>
<td>Global apps</td>
</tr>
<tr>
<td>100</td>
<td>+5ms</td>
<td>+10ms (-30ms regional)</td>
<td>~20ms net improvement</td>
<td>Enterprise scale</td>
</tr>
<tr>
<td>1000</td>
<td>+5ms</td>
<td>+12ms (-30ms regional)</td>
<td>~18ms net improvement</td>
<td>Massive scale</td>
</tr>
</tbody>
</table>
<p><strong>Location + Hash Mix</strong> (<code>{ read: 'location', write: 'hash' }</code>)</p>
<table>
<thead>
<tr>
<th>Shards</th>
<th>Read Latency</th>
<th>Write Latency</th>
<th>Combined Benefit</th>
<th>Best Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>+8ms (-30ms regional)</td>
<td>+5ms</td>
<td>~17ms net improvement</td>
<td>Read-heavy regional</td>
</tr>
<tr>
<td>100</td>
<td>+10ms (-30ms regional)</td>
<td>+5ms</td>
<td>~15ms net improvement</td>
<td>Analytics workloads</td>
</tr>
<tr>
<td>1000</td>
<td>+12ms (-30ms regional)</td>
<td>+5ms</td>
<td>~13ms net improvement</td>
<td>Large-scale reporting</td>
</tr>
</tbody>
</table>
<p><strong>Hash + Round-Robin Mix</strong> (<code>{ read: 'hash', write: 'round-robin' }</code>)</p>
<table>
<thead>
<tr>
<th>Shards</th>
<th>Read Latency</th>
<th>Write Latency</th>
<th>Distribution Quality</th>
<th>Best Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>+5ms</td>
<td>+15ms</td>
<td>Perfect writes, Excellent reads</td>
<td>Balanced workloads</td>
</tr>
<tr>
<td>100</td>
<td>+5ms</td>
<td>+20ms</td>
<td>Perfect writes, Excellent reads</td>
<td>Large databases</td>
</tr>
<tr>
<td>1000</td>
<td>+5ms</td>
<td>+25ms</td>
<td>Perfect writes, Excellent reads</td>
<td>Enterprise scale</td>
</tr>
</tbody>
</table>
<h3 id="mixed-strategy-scenarios--recommendations" class="tsd-anchor-link">Mixed Strategy Scenarios &amp; Recommendations<a href="#mixed-strategy-scenarios--recommendations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><h4 id="large-database-scenarios-10m-records" class="tsd-anchor-link">Large Database Scenarios (&gt;10M records)<a href="#large-database-scenarios-10m-records" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p><strong>Scenario</strong>: Massive datasets requiring optimal query performance and balanced growth</p>
<pre><code class="typescript"><span class="hl-3">// Recommended: Hash reads + Round-Robin writes</span><br/><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-11">strategy</span><span class="hl-1">: { </span><span class="hl-11">read</span><span class="hl-1">: </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1">, </span><span class="hl-11">write</span><span class="hl-1">: </span><span class="hl-2">&#39;round-robin&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-11">coordinator</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1"> </span><span class="hl-3">// Required for round-robin</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Performance Profile</strong>:</p>
<ul>
<li>Read latency: +5ms (fastest possible routing)</li>
<li>Write latency: +15-25ms (coordinator overhead)</li>
<li>Data distribution: Perfect balance over time</li>
<li><strong>Ideal for</strong>: Analytics platforms, data warehouses, reporting systems</li>
</ul>
<h4 id="vast-geographic-spread-scenarios" class="tsd-anchor-link">Vast Geographic Spread Scenarios<a href="#vast-geographic-spread-scenarios" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p><strong>Scenario</strong>: Global applications with users across multiple continents</p>
<pre><code class="typescript"><span class="hl-3">// Recommended: Hash reads + Location writes</span><br/><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-11">strategy</span><span class="hl-1">: { </span><span class="hl-11">read</span><span class="hl-1">: </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1">, </span><span class="hl-11">write</span><span class="hl-1">: </span><span class="hl-2">&#39;location&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-11">targetRegion</span><span class="hl-1">: </span><span class="hl-0">getClosestRegionFromIP</span><span class="hl-1">(</span><span class="hl-5">request</span><span class="hl-1">), </span><span class="hl-3">// Dynamic region targeting</span><br/><span class="hl-1">  </span><span class="hl-11">shardLocations</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;db-americas&#39;</span><span class="hl-1">: { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">2</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;db-europe&#39;</span><span class="hl-1">: { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;weur&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">2</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;db-asia&#39;</span><span class="hl-1">: { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;apac&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">2</span><span class="hl-1"> }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Performance Profile</strong>:</p>
<ul>
<li>Read latency: +5ms (consistent global performance)</li>
<li>Write latency: +8ms baseline (-20-40ms regional benefit)</li>
<li><strong>Net improvement</strong>: 15-35ms for geographically distributed users</li>
<li><strong>Ideal for</strong>: Social networks, e-commerce, content platforms</li>
</ul>
<h4 id="high-volume-write-scenarios" class="tsd-anchor-link">High-Volume Write Scenarios<a href="#high-volume-write-scenarios" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p><strong>Scenario</strong>: Applications with heavy write loads (IoT, logging, real-time data)</p>
<pre><code class="typescript"><span class="hl-3">// Recommended: Location reads + Hash writes</span><br/><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-11">strategy</span><span class="hl-1">: { </span><span class="hl-11">read</span><span class="hl-1">: </span><span class="hl-2">&#39;location&#39;</span><span class="hl-1">, </span><span class="hl-11">write</span><span class="hl-1">: </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-11">targetRegion</span><span class="hl-1">: </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">shardLocations</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-1">: { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">3</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;db-central&#39;</span><span class="hl-1">: { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;enam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">2</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-1">: { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;enam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">1</span><span class="hl-1"> }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Performance Profile</strong>:</p>
<ul>
<li>Read latency: +8ms baseline (-20-40ms regional benefit)</li>
<li>Write latency: +5ms (fastest write routing)</li>
<li>Write throughput: Maximum possible for hash strategy</li>
<li><strong>Ideal for</strong>: IoT data collection, real-time analytics, logging systems</li>
</ul>
<h4 id="multi-tenant-saas-scenarios" class="tsd-anchor-link">Multi-Tenant SaaS Scenarios<a href="#multi-tenant-saas-scenarios" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p><strong>Scenario</strong>: SaaS applications with predictable performance requirements</p>
<pre><code class="typescript"><span class="hl-3">// Recommended: Hash reads + Hash writes (consistent performance)</span><br/><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-11">strategy</span><span class="hl-1">: { </span><span class="hl-11">read</span><span class="hl-1">: </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1">, </span><span class="hl-11">write</span><span class="hl-1">: </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1"> }</span><br/><span class="hl-1">  </span><span class="hl-3">// No coordinator needed, predictable routing for both operations</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Performance Profile</strong>:</p>
<ul>
<li>Read latency: +5ms (most predictable)</li>
<li>Write latency: +5ms (most predictable)</li>
<li>Tenant isolation: Natural sharding by tenant ID</li>
<li><strong>Ideal for</strong>: B2B SaaS, multi-tenant platforms, predictable workloads</li>
</ul>
<h4 id="read-heavy-analytics-scenarios" class="tsd-anchor-link">Read-Heavy Analytics Scenarios<a href="#read-heavy-analytics-scenarios" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p><strong>Scenario</strong>: Analytics and reporting workloads with occasional writes</p>
<pre><code class="typescript"><span class="hl-3">// Recommended: Random reads + Location writes</span><br/><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-11">strategy</span><span class="hl-1">: { </span><span class="hl-11">read</span><span class="hl-1">: </span><span class="hl-2">&#39;random&#39;</span><span class="hl-1">, </span><span class="hl-11">write</span><span class="hl-1">: </span><span class="hl-2">&#39;location&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-11">targetRegion</span><span class="hl-1">: </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">shardLocations</span><span class="hl-1">: { </span><span class="hl-3">/* geographic configuration */</span><span class="hl-1"> }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Performance Profile</strong>:</p>
<ul>
<li>Read latency: +3ms (lowest overhead, good load balancing)</li>
<li>Write latency: +8ms baseline (-20-40ms regional benefit)</li>
<li>Read load distribution: Excellent across all shards</li>
<li><strong>Ideal for</strong>: Business intelligence, data analysis, reporting dashboards</li>
</ul>
<h3 id="mixed-strategy-performance-comparison" class="tsd-anchor-link">Mixed Strategy Performance Comparison<a href="#mixed-strategy-performance-comparison" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><h4 id="by-database-size" class="tsd-anchor-link">By Database Size<a href="#by-database-size" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th>Database Size</th>
<th>Best Mixed Strategy</th>
<th>Read Performance</th>
<th>Write Performance</th>
<th>Overall Benefit</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Small (1K-100K records)</strong></td>
<td><code>{read: 'hash', write: 'hash'}</code></td>
<td>Excellent</td>
<td>Excellent</td>
<td>Consistent, simple</td>
</tr>
<tr>
<td><strong>Medium (100K-1M records)</strong></td>
<td><code>{read: 'hash', write: 'location'}</code></td>
<td>Excellent</td>
<td>Good + Regional</td>
<td>15-35ms improvement</td>
</tr>
<tr>
<td><strong>Large (1M-10M records)</strong></td>
<td><code>{read: 'hash', write: 'round-robin'}</code></td>
<td>Excellent</td>
<td>Perfect distribution</td>
<td>Optimal scaling</td>
</tr>
<tr>
<td><strong>Very Large (10M+ records)</strong></td>
<td><code>{read: 'location', write: 'round-robin'}</code></td>
<td>Regional optimization</td>
<td>Perfect distribution</td>
<td>Best for global scale</td>
</tr>
</tbody>
</table>
<h4 id="by-geographic-distribution" class="tsd-anchor-link">By Geographic Distribution<a href="#by-geographic-distribution" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th>Geographic Spread</th>
<th>Best Mixed Strategy</th>
<th>Latency Improvement</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Single Region</strong></td>
<td><code>{read: 'hash', write: 'hash'}</code></td>
<td>+5ms both operations</td>
<td>Simple, fast</td>
</tr>
<tr>
<td><strong>Multi-Region</strong></td>
<td><code>{read: 'hash', write: 'location'}</code></td>
<td>15-35ms net improvement</td>
<td>Global apps</td>
</tr>
<tr>
<td><strong>Global</strong></td>
<td><code>{read: 'location', write: 'location'}</code></td>
<td>20-40ms both operations</td>
<td>Maximum geographic optimization</td>
</tr>
</tbody>
</table>
<h4 id="by-workload-pattern" class="tsd-anchor-link">By Workload Pattern<a href="#by-workload-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th>Workload Type</th>
<th>Read/Write Ratio</th>
<th>Best Mixed Strategy</th>
<th>Primary Benefit</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Read-Heavy</strong></td>
<td>90% reads</td>
<td><code>{read: 'random', write: 'location'}</code></td>
<td>Load-balanced queries</td>
</tr>
<tr>
<td><strong>Write-Heavy</strong></td>
<td>70% writes</td>
<td><code>{read: 'location', write: 'hash'}</code></td>
<td>Fast write processing</td>
</tr>
<tr>
<td><strong>Balanced</strong></td>
<td>50/50</td>
<td><code>{read: 'hash', write: 'hash'}</code></td>
<td>Consistent performance</td>
</tr>
<tr>
<td><strong>Analytics</strong></td>
<td>95% reads</td>
<td><code>{read: 'location', write: 'round-robin'}</code></td>
<td>Regional + perfect distribution</td>
</tr>
</tbody>
</table>
<h3 id="sha-256-hashing-performance-impact" class="tsd-anchor-link">SHA-256 Hashing Performance Impact<a href="#sha-256-hashing-performance-impact" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>CollegeDB uses SHA-256 hashing by default (<code>hashShardMappings: true</code>) to protect sensitive data in KV keys. This adds a small but measurable performance overhead:</p>
<h4 id="hashing-performance-characteristics" class="tsd-anchor-link">Hashing Performance Characteristics<a href="#hashing-performance-characteristics" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th>Operation Type</th>
<th>SHA-256 Overhead</th>
<th>Total Latency Impact</th>
<th>Security Benefit</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Query (Read)</strong></td>
<td>~1-2ms</td>
<td>2-4% increase</td>
<td>Keys hashed in KV storage</td>
</tr>
<tr>
<td><strong>Insert (Write)</strong></td>
<td>~2-3ms</td>
<td>2-3% increase</td>
<td>Multi-key mappings protected</td>
</tr>
<tr>
<td><strong>Update Mapping</strong></td>
<td>~1-3ms</td>
<td>1-2% increase</td>
<td>Existing keys remain secure</td>
</tr>
</tbody>
</table>
<h4 id="performance-by-key-length" class="tsd-anchor-link">Performance by Key Length<a href="#performance-by-key-length" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th>Key Type</th>
<th>Example</th>
<th>Hash Time</th>
<th>Recommendation</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Short keys</strong></td>
<td><code>user-123</code></td>
<td>~0.5-1ms</td>
<td>Minimal impact</td>
</tr>
<tr>
<td><strong>Medium keys</strong></td>
<td><code>email:user@example.com</code></td>
<td>~1-2ms</td>
<td>Good balance</td>
</tr>
<tr>
<td><strong>Long keys</strong></td>
<td><code>session:very-long-token-here</code></td>
<td>~2-3ms</td>
<td>Consider key shortening</td>
</tr>
<tr>
<td><strong>Multi-key operations</strong></td>
<td>3+ lookup keys</td>
<td>~3-5ms total</td>
<td>Benefits outweigh cost</td>
</tr>
</tbody>
</table>
<h4 id="hashing-vs-no-hashing-trade-offs" class="tsd-anchor-link">Hashing vs No-Hashing Trade-offs<a href="#hashing-vs-no-hashing-trade-offs" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-3">// With hashing (default - recommended for production)</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">secureConfig</span><span class="hl-1"> = {</span><br/><span class="hl-1">	</span><span class="hl-5">hashShardMappings:</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1"> </span><span class="hl-3">// Default</span><br/><span class="hl-1">	</span><span class="hl-3">// + Privacy: Sensitive data not visible in KV</span><br/><span class="hl-1">	</span><span class="hl-3">// + Security: Keys cannot be enumerated</span><br/><span class="hl-1">	</span><span class="hl-3">// - Performance: +1-3ms per operation</span><br/><span class="hl-1">	</span><span class="hl-3">// - Debugging: Original keys not recoverable</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-3">// Without hashing (development/debugging only)</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">developmentConfig</span><span class="hl-1"> = {</span><br/><span class="hl-1">	</span><span class="hl-5">hashShardMappings:</span><span class="hl-1"> </span><span class="hl-7">false</span><br/><span class="hl-1">	</span><span class="hl-3">// + Performance: No hashing overhead</span><br/><span class="hl-1">	</span><span class="hl-3">// + Debugging: Original keys visible in KV</span><br/><span class="hl-1">	</span><span class="hl-3">// - Privacy: Sensitive data exposed in KV keys</span><br/><span class="hl-1">	</span><span class="hl-3">// - Security: Keys can be enumerated</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<h4 id="optimization-recommendations" class="tsd-anchor-link">Optimization Recommendations<a href="#optimization-recommendations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><ol>
<li><strong>Keep keys reasonably short</strong> - Hash time scales with key length</li>
<li><strong>Use hashing in production</strong> - Security benefits outweigh minimal performance cost</li>
<li><strong>Disable hashing for development</strong> - When debugging shard distribution</li>
<li><strong>Monitor hash performance</strong> - Track operation latencies in high-volume scenarios</li>
</ol>
<p><strong>Bottom Line</strong>: SHA-256 hashing adds 1-3ms overhead but provides essential privacy and security benefits. The performance impact is minimal compared to network latency and D1 query time.</p>
<h3 id="real-world-scaling-benefits" class="tsd-anchor-link">Real-World Scaling Benefits<a href="#real-world-scaling-benefits" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><h4 id="database-size-limits" class="tsd-anchor-link">Database Size Limits<a href="#database-size-limits" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><strong>Single D1</strong>: Limited to D1's database size constraints</li>
<li><strong>CollegeDB</strong>: Virtually unlimited through horizontal distribution</li>
<li><strong>Data per shard</strong>: Scales inversely with shard count (1000 shards = 1/1000 data per shard)</li>
</ul>
<h4 id="geographic-distribution" class="tsd-anchor-link">Geographic Distribution<a href="#geographic-distribution" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-3">// Location-aware sharding reduces latency by 20-40ms</span><br/><span class="hl-0">initialize</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;location&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">targetRegion:</span><span class="hl-1"> </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">, </span><span class="hl-3">// Western North America</span><br/><span class="hl-1">  </span><span class="hl-5">shardLocations:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-5">:</span><span class="hl-1"> { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">2</span><span class="hl-1"> },    </span><span class="hl-3">// Preferred</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-5">:</span><span class="hl-1"> { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;enam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">1</span><span class="hl-1"> },    </span><span class="hl-3">// Secondary</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;db-europe&#39;</span><span class="hl-5">:</span><span class="hl-1"> { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;weur&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">0.5</span><span class="hl-1"> } </span><span class="hl-3">// Fallback</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-5">shards:</span><span class="hl-1"> { ... }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<h4 id="fault-tolerance" class="tsd-anchor-link">Fault Tolerance<a href="#fault-tolerance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><strong>Single D1</strong>: Single point of failure</li>
<li><strong>CollegeDB</strong>: Distributed failure isolation (failure of 1 shard affects only 1/N of data)</li>
</ul>
<h3 id="cost-performance-analysis" class="tsd-anchor-link">Cost-Performance Analysis<a href="#cost-performance-analysis" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Shards</th>
<th>D1 Costs**</th>
<th>Performance Gain</th>
<th>Cost per Performance Unit</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1x</td>
<td>1x</td>
<td>1.00x</td>
</tr>
<tr>
<td>10</td>
<td>1.2x</td>
<td>~9x</td>
<td>0.13x</td>
</tr>
<tr>
<td>100</td>
<td>2.5x</td>
<td>~80x</td>
<td>0.03x</td>
</tr>
<tr>
<td>1000</td>
<td>15x</td>
<td>~700x</td>
<td>0.02x</td>
</tr>
</tbody>
</table>
<p>**Estimated based on D1's pricing model including KV overhead</p>
<h3 id="when-to-use-collegedb" class="tsd-anchor-link">When to Use CollegeDB<a href="#when-to-use-collegedb" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>✅ <strong>Recommended for:</strong></p>
<ul>
<li>High-traffic applications (&gt;1000 QPS)</li>
<li>Large datasets approaching D1 limits</li>
<li>Geographic distribution requirements</li>
<li>Applications needing &gt;50 concurrent operations</li>
<li>Systems requiring fault tolerance</li>
</ul>
<p>✅ <strong>Mixed Strategy specifically recommended for:</strong></p>
<ul>
<li><strong>Global applications</strong> needing both fast queries and optimal data placement</li>
<li><strong>Large-scale databases</strong> requiring different optimization for reads vs writes</li>
<li><strong>Multi-workload systems</strong> with distinct read/write patterns</li>
<li><strong>Geographic optimization</strong> while maintaining query performance</li>
<li><strong>Enterprise applications</strong> needing fine-tuned performance control</li>
</ul>
<p>❌ <strong>Not recommended for:</strong></p>
<ul>
<li>Small applications (&lt;100 QPS)</li>
<li>Simple CRUD operations with minimal scale</li>
<li>Applications without geographic spread</li>
<li>Cost-sensitive deployments at small scale</li>
<li><strong>Single-strategy applications</strong> where reads and writes have identical performance needs</li>
</ul>
<h2 id="�🔧-advanced-configuration" class="tsd-anchor-link">�🔧 Advanced Configuration<a href="#�🔧-advanced-configuration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="custom-allocation-strategy" class="tsd-anchor-link">Custom Allocation Strategy<a href="#custom-allocation-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-0">initialize</span><span class="hl-1">({</span><br/><span class="hl-1">	</span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">shards:</span><span class="hl-1"> { </span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">[</span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-1">], </span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">[</span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-1">] },</span><br/><span class="hl-1">	</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1"> </span><span class="hl-3">// Shard selection based on primary key hash</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<h3 id="environment-specific-setup" class="tsd-anchor-link">Environment-Specific Setup<a href="#environment-specific-setup" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">config</span><span class="hl-1"> = {</span><br/><span class="hl-1">	</span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">shards:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">NODE_ENV</span><span class="hl-1"> === </span><span class="hl-2">&#39;production&#39;</span><span class="hl-1"> ? { </span><span class="hl-2">&#39;db-prod-1&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">[</span><span class="hl-2">&#39;db-prod-1&#39;</span><span class="hl-1">], </span><span class="hl-2">&#39;db-prod-2&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">[</span><span class="hl-2">&#39;db-prod-2&#39;</span><span class="hl-1">] } : { </span><span class="hl-2">&#39;db-dev&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">[</span><span class="hl-2">&#39;db-dev&#39;</span><span class="hl-1">] },</span><br/><span class="hl-1">	</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;round-robin&#39;</span><span class="hl-1"> </span><span class="hl-3">// Shard selection is evenly distributed, regardless of size</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-0">initialize</span><span class="hl-1">(</span><span class="hl-5">config</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h3 id="durable-objects-integration-shardcoordinator" class="tsd-anchor-link">Durable Objects Integration (ShardCoordinator)<a href="#durable-objects-integration-shardcoordinator" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>CollegeDB includes an optional <strong>ShardCoordinator</strong> Durable Object that provides centralized shard allocation and statistics management. This is particularly useful for round-robin allocation strategies and monitoring shard utilization across your application.</p>
<h4 id="durable-object-setup" class="tsd-anchor-link">Durable Object Setup<a href="#durable-object-setup" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p>First, configure the Durable Object in your <code>wrangler.toml</code>:</p>
<pre><code class="toml">[[durable_objects.bindings]]
name = "ShardCoordinator"
class_name = "ShardCoordinator"

# Export the ShardCoordinator class
[durable_objects.bindings.script_name]
# If using modules format
[[durable_objects.bindings]]
name = "ShardCoordinator"
class_name = "ShardCoordinator"
</code><button type="button">Copy</button></pre>

<h4 id="basic-usage-with-shardcoordinator" class="tsd-anchor-link">Basic Usage with ShardCoordinator<a href="#basic-usage-with-shardcoordinator" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="typescript"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">collegedb</span><span class="hl-1">, </span><span class="hl-5">ShardCoordinator</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;collegedb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Export the Durable Object class for Cloudflare Workers</span><br/><span class="hl-4">export</span><span class="hl-1"> { </span><span class="hl-5">ShardCoordinator</span><span class="hl-1"> };</span><br/><br/><span class="hl-4">export</span><span class="hl-1"> </span><span class="hl-4">default</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-5">request</span><span class="hl-1">: </span><span class="hl-8">Request</span><span class="hl-1">, </span><span class="hl-5">env</span><span class="hl-1">: </span><span class="hl-8">Env</span><span class="hl-1">): </span><span class="hl-8">Promise</span><span class="hl-1">&lt;</span><span class="hl-8">Response</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">		</span><span class="hl-3">// Initialize CollegeDB with coordinator support</span><br/><span class="hl-1">		</span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">collegedb</span><span class="hl-1">(</span><br/><span class="hl-1">			{</span><br/><span class="hl-1">				</span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">				</span><span class="hl-5">coordinator:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">, </span><span class="hl-3">// Add coordinator binding</span><br/><span class="hl-1">				</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;round-robin&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">				</span><span class="hl-5">shards:</span><span class="hl-1"> {</span><br/><span class="hl-1">					</span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_EAST</span><span class="hl-1">,</span><br/><span class="hl-1">					</span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_WEST</span><span class="hl-1">,</span><br/><span class="hl-1">					</span><span class="hl-2">&#39;db-central&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_CENTRAL</span><br/><span class="hl-1">				}</span><br/><span class="hl-1">			},</span><br/><span class="hl-1">			</span><span class="hl-7">async</span><span class="hl-1"> () </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">				</span><span class="hl-3">// Your application logic here</span><br/><span class="hl-1">				</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">user</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">first</span><span class="hl-1">(</span><span class="hl-2">&#39;user-123&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;SELECT * FROM users WHERE id = ?&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;user-123&#39;</span><span class="hl-1">]);</span><br/><span class="hl-1">				</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-5">Response</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">(</span><span class="hl-5">user</span><span class="hl-1">);</span><br/><span class="hl-1">			}</span><br/><span class="hl-1">		);</span><br/><span class="hl-1">	}</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<h4 id="shardcoordinator-http-api" class="tsd-anchor-link">ShardCoordinator HTTP API<a href="#shardcoordinator-http-api" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p>The ShardCoordinator exposes a comprehensive HTTP API for managing shards and allocation:</p>
<h5 id="shard-management" class="tsd-anchor-link">Shard Management<a href="#shard-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h5><pre><code class="typescript"><span class="hl-3">// Get coordinator instance</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinatorId</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">idFromName</span><span class="hl-1">(</span><span class="hl-2">&#39;default&#39;</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinator</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-5">coordinatorId</span><span class="hl-1">);</span><br/><br/><span class="hl-3">// List all registered shards</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">shardsResponse</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/shards&#39;</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">shards</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">shardsResponse</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">();</span><br/><span class="hl-3">// Returns: [&quot;db-east&quot;, &quot;db-west&quot;, &quot;db-central&quot;]</span><br/><br/><span class="hl-3">// Register a new shard</span><br/><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/shards&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">	</span><span class="hl-5">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;POST&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">headers:</span><span class="hl-1"> { </span><span class="hl-2">&#39;Content-Type&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-2">&#39;application/json&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">	</span><span class="hl-5">body:</span><span class="hl-1"> </span><span class="hl-6">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({ </span><span class="hl-5">shard:</span><span class="hl-1"> </span><span class="hl-2">&#39;db-new-region&#39;</span><span class="hl-1"> })</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-3">// Remove a shard</span><br/><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/shards&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">	</span><span class="hl-5">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;DELETE&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">headers:</span><span class="hl-1"> { </span><span class="hl-2">&#39;Content-Type&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-2">&#39;application/json&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">	</span><span class="hl-5">body:</span><span class="hl-1"> </span><span class="hl-6">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({ </span><span class="hl-5">shard:</span><span class="hl-1"> </span><span class="hl-2">&#39;db-old-region&#39;</span><span class="hl-1"> })</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<h5 id="statistics-and-monitoring" class="tsd-anchor-link">Statistics and Monitoring<a href="#statistics-and-monitoring" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h5><pre><code class="typescript"><span class="hl-3">// Get shard statistics</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">statsResponse</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/stats&#39;</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">stats</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">statsResponse</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">();</span><br/><span class="hl-3">/* Returns:</span><br/><span class="hl-3">[</span><br/><span class="hl-3">  {</span><br/><span class="hl-3">    &quot;binding&quot;: &quot;db-east&quot;,</span><br/><span class="hl-3">    &quot;count&quot;: 1542,</span><br/><span class="hl-3">    &quot;lastUpdated&quot;: 1672531200000</span><br/><span class="hl-3">  },</span><br/><span class="hl-3">  {</span><br/><span class="hl-3">    &quot;binding&quot;: &quot;db-west&quot;,</span><br/><span class="hl-3">    &quot;count&quot;: 1458,</span><br/><span class="hl-3">    &quot;lastUpdated&quot;: 1672531205000</span><br/><span class="hl-3">  }</span><br/><span class="hl-3">]</span><br/><span class="hl-3">*/</span><br/><br/><span class="hl-3">// Update shard statistics manually</span><br/><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/stats&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">	</span><span class="hl-5">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;POST&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">headers:</span><span class="hl-1"> { </span><span class="hl-2">&#39;Content-Type&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-2">&#39;application/json&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">	</span><span class="hl-5">body:</span><span class="hl-1"> </span><span class="hl-6">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({</span><br/><span class="hl-1">		</span><span class="hl-5">shard:</span><span class="hl-1"> </span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">count:</span><span class="hl-1"> </span><span class="hl-9">1600</span><br/><span class="hl-1">	})</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<h5 id="shard-allocation" class="tsd-anchor-link">Shard Allocation<a href="#shard-allocation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h5><pre><code class="typescript"><span class="hl-3">// Allocate a shard for a primary key</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">allocationResponse</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/allocate&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">	</span><span class="hl-5">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;POST&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">headers:</span><span class="hl-1"> { </span><span class="hl-2">&#39;Content-Type&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-2">&#39;application/json&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">	</span><span class="hl-5">body:</span><span class="hl-1"> </span><span class="hl-6">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({</span><br/><span class="hl-1">		</span><span class="hl-5">primaryKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;user-123&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;round-robin&#39;</span><span class="hl-1"> </span><span class="hl-3">// Optional, uses coordinator default if not specified</span><br/><span class="hl-1">	})</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-7">const</span><span class="hl-1"> { </span><span class="hl-6">shard</span><span class="hl-1"> } = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">allocationResponse</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">();</span><br/><span class="hl-3">// Returns: { &quot;shard&quot;: &quot;db-west&quot; }</span><br/><br/><span class="hl-3">// Hash-based allocation (consistent for same key)</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">hashAllocation</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/allocate&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">	</span><span class="hl-5">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;POST&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">	</span><span class="hl-5">headers:</span><span class="hl-1"> { </span><span class="hl-2">&#39;Content-Type&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-2">&#39;application/json&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">	</span><span class="hl-5">body:</span><span class="hl-1"> </span><span class="hl-6">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({</span><br/><span class="hl-1">		</span><span class="hl-5">primaryKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;user-456&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">strategy:</span><span class="hl-1"> </span><span class="hl-2">&#39;hash&#39;</span><br/><span class="hl-1">	})</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<h5 id="health-check-and-development" class="tsd-anchor-link">Health Check and Development<a href="#health-check-and-development" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h5><pre><code class="typescript"><span class="hl-3">// Health check endpoint</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">healthResponse</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/health&#39;</span><span class="hl-1">);</span><br/><span class="hl-3">// Returns: &quot;OK&quot; with 200 status</span><br/><br/><span class="hl-3">// Clear all coordinator state (DEVELOPMENT ONLY!)</span><br/><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/flush&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">	</span><span class="hl-5">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;POST&#39;</span><br/><span class="hl-1">});</span><br/><span class="hl-3">// WARNING: This removes all shard registrations and statistics</span>
</code><button type="button">Copy</button></pre>

<h4 id="programmatic-shard-management" class="tsd-anchor-link">Programmatic Shard Management<a href="#programmatic-shard-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p>The ShardCoordinator also provides methods for direct programmatic access:</p>
<pre><code class="typescript"><span class="hl-3">// Get coordinator instance</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinatorId</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">idFromName</span><span class="hl-1">(</span><span class="hl-2">&#39;default&#39;</span><span class="hl-1">);</span><br/><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinator</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-5">coordinatorId</span><span class="hl-1">);</span><br/><br/><span class="hl-3">// Increment shard count (when adding new keys)</span><br/><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">incrementShardCount</span><span class="hl-1">(</span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-3">// Decrement shard count (when removing keys)</span><br/><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">decrementShardCount</span><span class="hl-1">(</span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h4 id="advanced-monitoring-setup" class="tsd-anchor-link">Advanced Monitoring Setup<a href="#advanced-monitoring-setup" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Set up comprehensive monitoring of your shard distribution:</p>
<pre><code class="typescript"><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">monitorShardHealth</span><span class="hl-1">(</span><span class="hl-5">env</span><span class="hl-1">: </span><span class="hl-8">Env</span><span class="hl-1">) {</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinatorId</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">idFromName</span><span class="hl-1">(</span><span class="hl-2">&#39;default&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinator</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-5">coordinatorId</span><span class="hl-1">);</span><br/><br/><span class="hl-1">	</span><span class="hl-3">// Get current statistics</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">statsResponse</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/stats&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">stats</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">statsResponse</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">();</span><br/><br/><span class="hl-1">	</span><span class="hl-3">// Calculate distribution balance</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">totalKeys</span><span class="hl-1"> = </span><span class="hl-5">stats</span><span class="hl-1">.</span><span class="hl-0">reduce</span><span class="hl-1">((</span><span class="hl-5">sum</span><span class="hl-1">: </span><span class="hl-8">number</span><span class="hl-1">, </span><span class="hl-5">shard</span><span class="hl-1">: </span><span class="hl-8">any</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-5">sum</span><span class="hl-1"> + </span><span class="hl-5">shard</span><span class="hl-1">.</span><span class="hl-5">count</span><span class="hl-1">, </span><span class="hl-9">0</span><span class="hl-1">);</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">avgKeysPerShard</span><span class="hl-1"> = </span><span class="hl-5">totalKeys</span><span class="hl-1"> / </span><span class="hl-5">stats</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1">;</span><br/><br/><span class="hl-1">	</span><span class="hl-3">// Check for imbalanced shards (&gt;20% deviation from average)</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">imbalancedShards</span><span class="hl-1"> = </span><span class="hl-5">stats</span><span class="hl-1">.</span><span class="hl-0">filter</span><span class="hl-1">((</span><span class="hl-5">shard</span><span class="hl-1">: </span><span class="hl-8">any</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">deviation</span><span class="hl-1"> = </span><span class="hl-5">Math</span><span class="hl-1">.</span><span class="hl-0">abs</span><span class="hl-1">(</span><span class="hl-5">shard</span><span class="hl-1">.</span><span class="hl-5">count</span><span class="hl-1"> - </span><span class="hl-5">avgKeysPerShard</span><span class="hl-1">) / </span><span class="hl-5">avgKeysPerShard</span><span class="hl-1">;</span><br/><span class="hl-1">		</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-5">deviation</span><span class="hl-1"> &gt; </span><span class="hl-9">0.2</span><span class="hl-1">;</span><br/><span class="hl-1">	});</span><br/><br/><span class="hl-1">	</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">imbalancedShards</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1"> &gt; </span><span class="hl-9">0</span><span class="hl-1">) {</span><br/><span class="hl-1">		</span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">warn</span><span class="hl-1">(</span><span class="hl-2">&#39;Shard imbalance detected:&#39;</span><span class="hl-1">, </span><span class="hl-5">imbalancedShards</span><span class="hl-1">);</span><br/><span class="hl-1">		</span><span class="hl-3">// Trigger rebalancing logic or alerts</span><br/><span class="hl-1">	}</span><br/><br/><span class="hl-1">	</span><span class="hl-3">// Check for stale statistics (&gt;1 hour old)</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">now</span><span class="hl-1"> = </span><span class="hl-5">Date</span><span class="hl-1">.</span><span class="hl-0">now</span><span class="hl-1">();</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">staleShards</span><span class="hl-1"> = </span><span class="hl-5">stats</span><span class="hl-1">.</span><span class="hl-0">filter</span><span class="hl-1">((</span><span class="hl-5">shard</span><span class="hl-1">: </span><span class="hl-8">any</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-5">now</span><span class="hl-1"> - </span><span class="hl-5">shard</span><span class="hl-1">.</span><span class="hl-5">lastUpdated</span><span class="hl-1"> &gt; </span><span class="hl-9">3600000</span><span class="hl-1">; </span><span class="hl-3">// 1 hour in ms</span><br/><span class="hl-1">	});</span><br/><br/><span class="hl-1">	</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">staleShards</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1"> &gt; </span><span class="hl-9">0</span><span class="hl-1">) {</span><br/><span class="hl-1">		</span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">warn</span><span class="hl-1">(</span><span class="hl-2">&#39;Stale shard statistics detected:&#39;</span><span class="hl-1">, </span><span class="hl-5">staleShards</span><span class="hl-1">);</span><br/><span class="hl-1">	}</span><br/><br/><span class="hl-1">	</span><span class="hl-4">return</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-5">totalKeys</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">avgKeysPerShard</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">balance:</span><span class="hl-1"> </span><span class="hl-5">imbalancedShards</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1"> === </span><span class="hl-9">0</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">freshStats:</span><span class="hl-1"> </span><span class="hl-5">staleShards</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1"> === </span><span class="hl-9">0</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">shards:</span><span class="hl-1"> </span><span class="hl-5">stats</span><br/><span class="hl-1">	};</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h4 id="error-handling-with-shardcoordinator" class="tsd-anchor-link">Error Handling with ShardCoordinator<a href="#error-handling-with-shardcoordinator" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p>When using the ShardCoordinator, ensure you handle potential errors gracefully:</p>
<pre><code class="typescript"><span class="hl-4">try</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinator</span><span class="hl-1"> = </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-5">coordinatorId</span><span class="hl-1">);</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">response</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/allocate&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">		</span><span class="hl-5">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;POST&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">		</span><span class="hl-5">headers:</span><span class="hl-1"> { </span><span class="hl-2">&#39;Content-Type&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-2">&#39;application/json&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">		</span><span class="hl-5">body:</span><span class="hl-1"> </span><span class="hl-6">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({ </span><span class="hl-5">primaryKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;user-123&#39;</span><span class="hl-1"> })</span><br/><span class="hl-1">	});</span><br/><br/><span class="hl-1">	</span><span class="hl-4">if</span><span class="hl-1"> (!</span><span class="hl-5">response</span><span class="hl-1">.</span><span class="hl-5">ok</span><span class="hl-1">) {</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">error</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">response</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">();</span><br/><span class="hl-1">		</span><span class="hl-4">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`ShardCoordinator error: </span><span class="hl-7">${</span><span class="hl-5">error</span><span class="hl-10">.</span><span class="hl-5">error</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">	}</span><br/><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> { </span><span class="hl-6">shard</span><span class="hl-1"> } = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">response</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">();</span><br/><span class="hl-1">	</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-5">shard</span><span class="hl-1">;</span><br/><span class="hl-1">} </span><span class="hl-4">catch</span><span class="hl-1"> (</span><span class="hl-5">error</span><span class="hl-1">) {</span><br/><span class="hl-1">	</span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-2">&#39;Failed to allocate shard:&#39;</span><span class="hl-1">, </span><span class="hl-5">error</span><span class="hl-1">);</span><br/><span class="hl-1">	</span><span class="hl-3">// Fallback to hash-based allocation without coordinator</span><br/><span class="hl-1">	</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-0">hashFunction</span><span class="hl-1">(</span><span class="hl-2">&#39;user-123&#39;</span><span class="hl-1">, </span><span class="hl-5">availableShards</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h4 id="performance-considerations" class="tsd-anchor-link">Performance Considerations<a href="#performance-considerations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li><strong>Coordinator Latency</strong>: Round-robin allocation adds ~10-20ms latency due to coordinator communication</li>
<li><strong>Scalability</strong>: Single coordinator instance can handle thousands of allocations per second</li>
<li><strong>Fault Tolerance</strong>: Design fallback allocation strategies when coordinator is unavailable</li>
<li><strong>Caching</strong>: Consider caching allocation results for frequently accessed keys</li>
</ul>
<pre><code class="typescript"><span class="hl-3">// Fallback allocation when coordinator is unavailable</span><br/><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">fallbackAllocation</span><span class="hl-1">(</span><span class="hl-5">primaryKey</span><span class="hl-1">: </span><span class="hl-8">string</span><span class="hl-1">, </span><span class="hl-5">shards</span><span class="hl-1">: </span><span class="hl-8">string</span><span class="hl-1">[]): </span><span class="hl-8">string</span><span class="hl-1"> {</span><br/><span class="hl-1">	</span><span class="hl-3">// Use hash-based allocation as fallback</span><br/><span class="hl-1">	</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">hash</span><span class="hl-1"> = </span><span class="hl-0">simpleHash</span><span class="hl-1">(</span><span class="hl-5">primaryKey</span><span class="hl-1">);</span><br/><span class="hl-1">	</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-5">shards</span><span class="hl-1">[</span><span class="hl-5">hash</span><span class="hl-1"> % </span><span class="hl-5">shards</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1">];</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-7">async</span><span class="hl-1"> </span><span class="hl-7">function</span><span class="hl-1"> </span><span class="hl-0">allocateWithFallback</span><span class="hl-1">(</span><span class="hl-5">coordinator</span><span class="hl-1">: </span><span class="hl-8">DurableObjectNamespace</span><span class="hl-1">, </span><span class="hl-5">primaryKey</span><span class="hl-1">: </span><span class="hl-8">string</span><span class="hl-1">, </span><span class="hl-5">shards</span><span class="hl-1">: </span><span class="hl-8">string</span><span class="hl-1">[]): </span><span class="hl-8">Promise</span><span class="hl-1">&lt;</span><span class="hl-8">string</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">	</span><span class="hl-4">try</span><span class="hl-1"> {</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">coordinatorId</span><span class="hl-1"> = </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">idFromName</span><span class="hl-1">(</span><span class="hl-2">&#39;default&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">instance</span><span class="hl-1"> = </span><span class="hl-5">coordinator</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-5">coordinatorId</span><span class="hl-1">);</span><br/><br/><span class="hl-1">		</span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-6">response</span><span class="hl-1"> = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">instance</span><span class="hl-1">.</span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;http://coordinator/allocate&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">			</span><span class="hl-5">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;POST&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">			</span><span class="hl-5">headers:</span><span class="hl-1"> { </span><span class="hl-2">&#39;Content-Type&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-2">&#39;application/json&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">			</span><span class="hl-5">body:</span><span class="hl-1"> </span><span class="hl-6">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({ </span><span class="hl-5">primaryKey</span><span class="hl-1"> })</span><br/><span class="hl-1">		});</span><br/><br/><span class="hl-1">		</span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">response</span><span class="hl-1">.</span><span class="hl-5">ok</span><span class="hl-1">) {</span><br/><span class="hl-1">			</span><span class="hl-7">const</span><span class="hl-1"> { </span><span class="hl-6">shard</span><span class="hl-1"> } = </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-5">response</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">();</span><br/><span class="hl-1">			</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-5">shard</span><span class="hl-1">;</span><br/><span class="hl-1">		}</span><br/><span class="hl-1">	} </span><span class="hl-4">catch</span><span class="hl-1"> (</span><span class="hl-5">error</span><span class="hl-1">) {</span><br/><span class="hl-1">		</span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">warn</span><span class="hl-1">(</span><span class="hl-2">&#39;Coordinator unavailable, using fallback allocation:&#39;</span><span class="hl-1">, </span><span class="hl-5">error</span><span class="hl-1">);</span><br/><span class="hl-1">	}</span><br/><br/><span class="hl-1">	</span><span class="hl-3">// Fallback to hash-based allocation</span><br/><span class="hl-1">	</span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-0">fallbackAllocation</span><span class="hl-1">(</span><span class="hl-5">primaryKey</span><span class="hl-1">, </span><span class="hl-5">shards</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h2 id="🚀-quick-reference" class="tsd-anchor-link">🚀 Quick Reference<a href="#🚀-quick-reference" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="strategy-selection-guide" class="tsd-anchor-link">Strategy Selection Guide<a href="#strategy-selection-guide" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Strategy</th>
<th>Use Case</th>
<th>Latency</th>
<th>Distribution</th>
<th>Coordinator Required</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>hash</code></td>
<td>High-volume apps, consistent performance</td>
<td>Lowest</td>
<td>Excellent</td>
<td>No</td>
</tr>
<tr>
<td><code>round-robin</code></td>
<td>Guaranteed even distribution</td>
<td>Medium</td>
<td>Perfect</td>
<td>Yes</td>
</tr>
<tr>
<td><code>random</code></td>
<td>Simple setup, good enough distribution</td>
<td>Low</td>
<td>Good</td>
<td>No</td>
</tr>
<tr>
<td><code>location</code></td>
<td>Geographic optimization, reduced latency</td>
<td>Region-optimized</td>
<td>Good</td>
<td>No</td>
</tr>
<tr>
<td><code>mixed</code></td>
<td>Optimized read/write performance</td>
<td>Strategy-dependent</td>
<td>Variable</td>
<td>Strategy-dependent</td>
</tr>
</tbody>
</table>
<h4 id="mixed-strategy-recommendations-by-scenario" class="tsd-anchor-link">Mixed Strategy Recommendations by Scenario<a href="#mixed-strategy-recommendations-by-scenario" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><table>
<thead>
<tr>
<th>Scenario</th>
<th>Recommended Mix</th>
<th>Read Strategy</th>
<th>Write Strategy</th>
<th>Benefits</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Large Databases (&gt;10M records)</strong></td>
<td><code>{read: 'hash', write: 'round-robin'}</code></td>
<td>Hash</td>
<td>Round-Robin</td>
<td>Fastest reads, even data distribution</td>
</tr>
<tr>
<td><strong>Global Applications</strong></td>
<td><code>{read: 'hash', write: 'location'}</code></td>
<td>Hash</td>
<td>Location</td>
<td>Fast queries, optimal geographic placement</td>
</tr>
<tr>
<td><strong>High Write Volume</strong></td>
<td><code>{read: 'location', write: 'hash'}</code></td>
<td>Location</td>
<td>Hash</td>
<td>Regional read optimization, fast write routing</td>
</tr>
<tr>
<td><strong>Analytics Workloads</strong></td>
<td><code>{read: 'random', write: 'location'}</code></td>
<td>Random</td>
<td>Location</td>
<td>Load-balanced queries, optimal data placement</td>
</tr>
<tr>
<td><strong>Multi-Tenant SaaS</strong></td>
<td><code>{read: 'hash', write: 'hash'}</code></td>
<td>Hash</td>
<td>Hash</td>
<td>Consistent performance, predictable routing</td>
</tr>
</tbody>
</table>
<h3 id="configuration-templates" class="tsd-anchor-link">Configuration Templates<a href="#configuration-templates" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p><strong>Hash Strategy (Recommended for most apps):</strong></p>
<pre><code class="typescript"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-11">kv</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">strategy</span><span class="hl-1">: </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">shards</span><span class="hl-1">: { </span><span class="hl-2">&#39;db-1&#39;</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_1</span><span class="hl-1">, </span><span class="hl-2">&#39;db-2&#39;</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_2</span><span class="hl-1"> }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Location Strategy (Geographic optimization):</strong></p>
<pre><code class="typescript"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-11">kv</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">strategy</span><span class="hl-1">: </span><span class="hl-2">&#39;location&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">targetRegion</span><span class="hl-1">: </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">shardLocations</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-1">: { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">2</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-1">: { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;enam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">1</span><span class="hl-1"> }</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-11">shards</span><span class="hl-1">: { </span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_WEST</span><span class="hl-1">, </span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_EAST</span><span class="hl-1"> }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Round-Robin Strategy (Even distribution):</strong></p>
<pre><code class="typescript"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-11">kv</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">coordinator</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">strategy</span><span class="hl-1">: </span><span class="hl-2">&#39;round-robin&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">shards</span><span class="hl-1">: { </span><span class="hl-2">&#39;db-1&#39;</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_1</span><span class="hl-1">, </span><span class="hl-2">&#39;db-2&#39;</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_2</span><span class="hl-1">, </span><span class="hl-2">&#39;db-3&#39;</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_3</span><span class="hl-1"> }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Mixed Strategy (Global applications):</strong></p>
<pre><code class="typescript"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-11">kv</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">strategy</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-11">read</span><span class="hl-1">: </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1">,      </span><span class="hl-3">// Fast, consistent reads</span><br/><span class="hl-1">    </span><span class="hl-11">write</span><span class="hl-1">: </span><span class="hl-2">&#39;location&#39;</span><span class="hl-1">  </span><span class="hl-3">// Optimal geographic placement</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-11">targetRegion</span><span class="hl-1">: </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">shardLocations</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-1">: { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;wnam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">2</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-1">: { </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;enam&#39;</span><span class="hl-1">, </span><span class="hl-5">priority:</span><span class="hl-1"> </span><span class="hl-9">1</span><span class="hl-1"> }</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-11">shards</span><span class="hl-1">: { </span><span class="hl-2">&#39;db-west&#39;</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_WEST</span><span class="hl-1">, </span><span class="hl-2">&#39;db-east&#39;</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_EAST</span><span class="hl-1"> }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Mixed Strategy (Large databases):</strong></p>
<pre><code class="typescript"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-11">kv</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">coordinator</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-5">ShardCoordinator</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">strategy</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-11">read</span><span class="hl-1">: </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1">,         </span><span class="hl-3">// Fastest possible reads</span><br/><span class="hl-1">    </span><span class="hl-11">write</span><span class="hl-1">: </span><span class="hl-2">&#39;round-robin&#39;</span><span class="hl-1">  </span><span class="hl-3">// Perfect distribution</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-11">shards</span><span class="hl-1">: { </span><span class="hl-2">&#39;db-1&#39;</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_1</span><span class="hl-1">, </span><span class="hl-2">&#39;db-2&#39;</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_2</span><span class="hl-1">, </span><span class="hl-2">&#39;db-3&#39;</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_3</span><span class="hl-1"> }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Mixed Strategy (High-performance consistent):</strong></p>
<pre><code class="typescript"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-11">kv</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">KV</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-11">strategy</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-11">read</span><span class="hl-1">: </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1">,   </span><span class="hl-3">// Predictable read performance</span><br/><span class="hl-1">    </span><span class="hl-11">write</span><span class="hl-1">: </span><span class="hl-2">&#39;hash&#39;</span><span class="hl-1">   </span><span class="hl-3">// Predictable write performance</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-11">shards</span><span class="hl-1">: { </span><span class="hl-2">&#39;db-1&#39;</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_1</span><span class="hl-1">, </span><span class="hl-2">&#39;db-2&#39;</span><span class="hl-1">: </span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-6">DB_2</span><span class="hl-1"> }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="region-codes-reference" class="tsd-anchor-link">Region Codes Reference<a href="#region-codes-reference" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><table>
<thead>
<tr>
<th>Code</th>
<th>Region</th>
<th>Typical Location</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>wnam</code></td>
<td>Western North America</td>
<td>San Francisco</td>
</tr>
<tr>
<td><code>enam</code></td>
<td>Eastern North America</td>
<td>New York</td>
</tr>
<tr>
<td><code>weur</code></td>
<td>Western Europe</td>
<td>London</td>
</tr>
<tr>
<td><code>eeur</code></td>
<td>Eastern Europe</td>
<td>Berlin</td>
</tr>
<tr>
<td><code>apac</code></td>
<td>Asia Pacific</td>
<td>Tokyo</td>
</tr>
<tr>
<td><code>oc</code></td>
<td>Oceania</td>
<td>Sydney</td>
</tr>
<tr>
<td><code>me</code></td>
<td>Middle East</td>
<td>Dubai</td>
</tr>
<tr>
<td><code>af</code></td>
<td>Africa</td>
<td>Johannesburg</td>
</tr>
</tbody>
</table>
<h2 id="🤝-contributing" class="tsd-anchor-link">🤝 Contributing<a href="#🤝-contributing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ol>
<li>Fork the repository</li>
<li>Create a feature branch: <code>git checkout -b feature/amazing-feature</code></li>
<li>Commit changes: <code>git commit -m 'Add amazing feature'</code></li>
<li>Push to branch: <code>git push origin feature/amazing-feature</code></li>
<li>Submit a pull request</li>
</ol>
<h2 id="📝-license" class="tsd-anchor-link">📝 License<a href="#📝-license" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This project is licensed under the MIT License - see the <a href="media/LICENSE">LICENSE</a> file for details.</p>
<h2 id="🔗-links" class="tsd-anchor-link">🔗 Links<a href="#🔗-links" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li><a href="https://developers.cloudflare.com/d1/">Cloudflare D1 Documentation</a></li>
<li><a href="https://developers.cloudflare.com/kv/">Cloudflare KV Documentation</a></li>
<li><a href="https://developers.cloudflare.com/workers/">Cloudflare Workers Documentation</a></li>
<li><a href="https://developers.cloudflare.com/durable-objects/">Durable Objects Documentation</a></li>
</ul>
<h2 id="🆘-support" class="tsd-anchor-link">🆘 Support<a href="#🆘-support" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>📖 <a href="https://earth-app.github.io/CollegeDB">Documentation</a></li>
<li>🐛 <a href="https://github.com/earth-app/CollegeDB/issues">Report Issues</a></li>
<li>💬 <a href="https://github.com/earth-app/CollegeDB/discussions">Discussions</a></li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#collegedb"><span>College<wbr/>DB</span></a><ul><li><a href="#📈-overview"><span>📈 <wbr/>Overview</span></a></li><li><a href="#📦-features"><span>📦 <wbr/>Features</span></a></li><li><a href="#installation"><span>Installation</span></a></li><li><a href="#basic-usage"><span>Basic <wbr/>Usage</span></a></li><li><ul><li><a href="#geographic-distribution-example"><span>Geographic <wbr/>Distribution <wbr/>Example</span></a></li><li><a href="#mixed-strategy-example"><span>Mixed <wbr/>Strategy <wbr/>Example</span></a></li></ul></li><li><a href="#multi-key-shard-mappings"><span>Multi-<wbr/>Key <wbr/>Shard <wbr/>Mappings</span></a></li><li><ul><li><a href="#adding-lookup-keys-to-existing-mappings"><span>Adding <wbr/>Lookup <wbr/>Keys to <wbr/>Existing <wbr/>Mappings</span></a></li><li><a href="#security-and-privacy"><span>Security and <wbr/>Privacy</span></a></li><li><a href="#multi-key-management"><span>Multi-<wbr/>Key <wbr/>Management</span></a></li></ul></li><li><a href="#drop-in-replacement-for-existing-databases"><span>Drop-<wbr/>in <wbr/>Replacement for <wbr/>Existing <wbr/>Databases</span></a></li><li><ul><li><a href="#requirements-for-drop-in-replacement"><span>Requirements for <wbr/>Drop-<wbr/>in <wbr/>Replacement</span></a></li><li><a href="#manual-validation-optional"><span>Manual <wbr/>Validation (<wbr/>Optional)</span></a></li><li><a href="#manual-data-discovery-optional"><span>Manual <wbr/>Data <wbr/>Discovery (<wbr/>Optional)</span></a></li><li><a href="#manual-integration-optional"><span>Manual <wbr/>Integration (<wbr/>Optional)</span></a></li><li><a href="#complete-drop-in-example"><span>Complete <wbr/>Drop-<wbr/>in <wbr/>Example</span></a></li><li><a href="#manual-integration-example"><span>Manual <wbr/>Integration <wbr/>Example</span></a></li><li><a href="#performance-impact"><span>Performance <wbr/>Impact</span></a></li></ul></li><li><a href="#troubleshooting"><span>Troubleshooting</span></a></li><li><ul><li><a href="#tables-without-primary-keys"><span>Tables without <wbr/>Primary <wbr/>Keys</span></a></li><li><a href="#large-database-integration"><span>Large <wbr/>Database <wbr/>Integration</span></a></li><li><a href="#mixed-primary-key-types"><span>Mixed <wbr/>Primary <wbr/>Key <wbr/>Types</span></a></li></ul></li><li><a href="#📚-api-reference"><span>📚 <wbr/>API <wbr/>Reference</span></a></li><li><ul><li><a href="#drop-in-replacement-functions"><span>Drop-<wbr/>in <wbr/>Replacement <wbr/>Functions</span></a></li><li><a href="#error-handling"><span>Error <wbr/>Handling</span></a></li><li><a href="#shardcoordinator-durable-object-api"><span>Shard<wbr/>Coordinator (<wbr/>Durable <wbr/>Object) <wbr/>API</span></a></li><li><ul><li><a href="#http-api-endpoints"><span>HTTP <wbr/>API <wbr/>Endpoints</span></a></li><li><a href="#programmatic-methods"><span>Programmatic <wbr/>Methods</span></a></li><li><a href="#usage-example"><span>Usage <wbr/>Example</span></a></li></ul></li><li><a href="#configuration-types"><span>Configuration <wbr/>Types</span></a></li><li><ul><li><a href="#collegedbconfig"><span>College<wbr/>DB<wbr/>Config</span></a></li><li><a href="#strategy-types"><span>Strategy <wbr/>Types</span></a></li><li><a href="#example-configurations"><span>Example <wbr/>Configurations</span></a></li></ul></li><li><a href="#types"><span>Types</span></a></li><li><ul><li><a href="#mixed-strategy-configuration"><span>Mixed <wbr/>Strategy <wbr/>Configuration</span></a></li></ul></li></ul></li><li><a href="#🏗-architecture"><span>🏗 <wbr/>Architecture</span></a></li><li><ul><li><a href="#data-flow"><span>Data <wbr/>Flow</span></a></li><li><ul><li><a href="#without-shardcoordinator-hashrandomlocation-strategies"><span>Without <wbr/>Shard<wbr/>Coordinator (<wbr/>Hash/<wbr/>Random/<wbr/>Location strategies)</span></a></li><li><a href="#with-shardcoordinator-round-robin-strategy"><span>With <wbr/>Shard<wbr/>Coordinator (<wbr/>Round-<wbr/>Robin strategy)</span></a></li><li><a href="#shardcoordinator-internal-flow"><span>Shard<wbr/>Coordinator <wbr/>Internal <wbr/>Flow</span></a></li></ul></li><li><a href="#shard-allocation-strategies"><span>Shard <wbr/>Allocation <wbr/>Strategies</span></a></li></ul></li><li><a href="#🌐-cloudflare-setup"><span>🌐 <wbr/>Cloudflare <wbr/>Setup</span></a></li><li><ul><li><a href="#1-create-d1-databases"><span>1. <wbr/>Create <wbr/>D1 <wbr/>Databases</span></a></li><li><a href="#2-create-kv-namespace"><span>2. <wbr/>Create <wbr/>KV <wbr/>Namespace</span></a></li><li><a href="#3-configure-wranglertoml"><span>3. <wbr/>Configure wrangler.toml</span></a></li><li><ul><li><a href="#complete-wranglertoml-with-shardcoordinator"><span>Complete wrangler.toml with <wbr/>Shard<wbr/>Coordinator</span></a></li></ul></li><li><a href="#31-worker-script-setup-required-for-shardcoordinator"><span>3.1. <wbr/>Worker <wbr/>Script <wbr/>Setup (<wbr/>Required for <wbr/>Shard<wbr/>Coordinator)</span></a></li><li><a href="#4-deploy"><span>4. <wbr/>Deploy</span></a></li></ul></li><li><a href="#📊-monitoring-and-maintenance"><span>📊 <wbr/>Monitoring and <wbr/>Maintenance</span></a></li><li><ul><li><a href="#shard-statistics"><span>Shard <wbr/>Statistics</span></a></li><li><ul><li><a href="#using-collegedb-functions"><span>Using <wbr/>College<wbr/>DB <wbr/>Functions</span></a></li><li><a href="#using-shardcoordinator-directly"><span>Using <wbr/>Shard<wbr/>Coordinator <wbr/>Directly</span></a></li><li><a href="#advanced-monitoring-dashboard"><span>Advanced <wbr/>Monitoring <wbr/>Dashboard</span></a></li></ul></li><li><a href="#shard-rebalancing"><span>Shard <wbr/>Rebalancing</span></a></li><li><a href="#health-monitoring"><span>Health <wbr/>Monitoring</span></a></li><li><ul><li><a href="#automated-health-checks"><span>Automated <wbr/>Health <wbr/>Checks</span></a></li><li><a href="#alerting-and-monitoring-integration"><span>Alerting and <wbr/>Monitoring <wbr/>Integration</span></a></li></ul></li></ul></li><li><a href="#⚙️-performance-analysis"><span>⚙️ <wbr/>Performance <wbr/>Analysis</span></a></li><li><ul><li><a href="#scaling-performance-comparison"><span>Scaling <wbr/>Performance <wbr/>Comparison</span></a></li><li><ul><li><a href="#query-performance"><span>Query <wbr/>Performance</span></a></li><li><a href="#write-performance"><span>Write <wbr/>Performance</span></a></li></ul></li><li><a href="#strategy-specific-performance"><span>Strategy-<wbr/>Specific <wbr/>Performance</span></a></li><li><ul><li><a href="#hash-strategy"><span>Hash <wbr/>Strategy</span></a></li><li><a href="#round-robin-strategy"><span>Round-<wbr/>Robin <wbr/>Strategy</span></a></li><li><a href="#random-strategy"><span>Random <wbr/>Strategy</span></a></li><li><a href="#location-strategy"><span>Location <wbr/>Strategy</span></a></li><li><a href="#mixed-strategy"><span>Mixed <wbr/>Strategy</span></a></li><li><ul><li><a href="#by-shard-count"><span>By <wbr/>Shard <wbr/>Count</span></a></li></ul></li></ul></li><li><a href="#mixed-strategy-scenarios--recommendations"><span>Mixed <wbr/>Strategy <wbr/>Scenarios &amp; <wbr/>Recommendations</span></a></li><li><ul><li><a href="#large-database-scenarios-10m-records"><span>Large <wbr/>Database <wbr/>Scenarios (&gt;10<wbr/>M records)</span></a></li><li><a href="#vast-geographic-spread-scenarios"><span>Vast <wbr/>Geographic <wbr/>Spread <wbr/>Scenarios</span></a></li><li><a href="#high-volume-write-scenarios"><span>High-<wbr/>Volume <wbr/>Write <wbr/>Scenarios</span></a></li><li><a href="#multi-tenant-saas-scenarios"><span>Multi-<wbr/>Tenant <wbr/>Saa<wbr/>S <wbr/>Scenarios</span></a></li><li><a href="#read-heavy-analytics-scenarios"><span>Read-<wbr/>Heavy <wbr/>Analytics <wbr/>Scenarios</span></a></li></ul></li><li><a href="#mixed-strategy-performance-comparison"><span>Mixed <wbr/>Strategy <wbr/>Performance <wbr/>Comparison</span></a></li><li><ul><li><a href="#by-database-size"><span>By <wbr/>Database <wbr/>Size</span></a></li><li><a href="#by-geographic-distribution"><span>By <wbr/>Geographic <wbr/>Distribution</span></a></li><li><a href="#by-workload-pattern"><span>By <wbr/>Workload <wbr/>Pattern</span></a></li></ul></li><li><a href="#sha-256-hashing-performance-impact"><span>SHA-<wbr/>256 <wbr/>Hashing <wbr/>Performance <wbr/>Impact</span></a></li><li><ul><li><a href="#hashing-performance-characteristics"><span>Hashing <wbr/>Performance <wbr/>Characteristics</span></a></li><li><a href="#performance-by-key-length"><span>Performance by <wbr/>Key <wbr/>Length</span></a></li><li><a href="#hashing-vs-no-hashing-trade-offs"><span>Hashing vs <wbr/>No-<wbr/>Hashing <wbr/>Trade-<wbr/>offs</span></a></li><li><a href="#optimization-recommendations"><span>Optimization <wbr/>Recommendations</span></a></li></ul></li><li><a href="#real-world-scaling-benefits"><span>Real-<wbr/>World <wbr/>Scaling <wbr/>Benefits</span></a></li><li><ul><li><a href="#database-size-limits"><span>Database <wbr/>Size <wbr/>Limits</span></a></li><li><a href="#geographic-distribution"><span>Geographic <wbr/>Distribution</span></a></li><li><a href="#fault-tolerance"><span>Fault <wbr/>Tolerance</span></a></li></ul></li><li><a href="#cost-performance-analysis"><span>Cost-<wbr/>Performance <wbr/>Analysis</span></a></li><li><a href="#when-to-use-collegedb"><span>When to <wbr/>Use <wbr/>College<wbr/>DB</span></a></li></ul></li><li><a href="#�🔧-advanced-configuration"><span>�🔧 <wbr/>Advanced <wbr/>Configuration</span></a></li><li><ul><li><a href="#custom-allocation-strategy"><span>Custom <wbr/>Allocation <wbr/>Strategy</span></a></li><li><a href="#environment-specific-setup"><span>Environment-<wbr/>Specific <wbr/>Setup</span></a></li><li><a href="#durable-objects-integration-shardcoordinator"><span>Durable <wbr/>Objects <wbr/>Integration (<wbr/>Shard<wbr/>Coordinator)</span></a></li><li><ul><li><a href="#durable-object-setup"><span>Durable <wbr/>Object <wbr/>Setup</span></a></li><li><a href="#basic-usage-with-shardcoordinator"><span>Basic <wbr/>Usage with <wbr/>Shard<wbr/>Coordinator</span></a></li><li><a href="#shardcoordinator-http-api"><span>Shard<wbr/>Coordinator <wbr/>HTTP <wbr/>API</span></a></li><li><ul><li><a href="#shard-management"><span>Shard <wbr/>Management</span></a></li><li><a href="#statistics-and-monitoring"><span>Statistics and <wbr/>Monitoring</span></a></li><li><a href="#shard-allocation"><span>Shard <wbr/>Allocation</span></a></li><li><a href="#health-check-and-development"><span>Health <wbr/>Check and <wbr/>Development</span></a></li></ul></li><li><a href="#programmatic-shard-management"><span>Programmatic <wbr/>Shard <wbr/>Management</span></a></li><li><a href="#advanced-monitoring-setup"><span>Advanced <wbr/>Monitoring <wbr/>Setup</span></a></li><li><a href="#error-handling-with-shardcoordinator"><span>Error <wbr/>Handling with <wbr/>Shard<wbr/>Coordinator</span></a></li><li><a href="#performance-considerations"><span>Performance <wbr/>Considerations</span></a></li></ul></li></ul></li><li><a href="#🚀-quick-reference"><span>🚀 <wbr/>Quick <wbr/>Reference</span></a></li><li><ul><li><a href="#strategy-selection-guide"><span>Strategy <wbr/>Selection <wbr/>Guide</span></a></li><li><ul><li><a href="#mixed-strategy-recommendations-by-scenario"><span>Mixed <wbr/>Strategy <wbr/>Recommendations by <wbr/>Scenario</span></a></li></ul></li><li><a href="#configuration-templates"><span>Configuration <wbr/>Templates</span></a></li><li><a href="#region-codes-reference"><span>Region <wbr/>Codes <wbr/>Reference</span></a></li></ul></li><li><a href="#🤝-contributing"><span>🤝 <wbr/>Contributing</span></a></li><li><a href="#📝-license"><span>📝 <wbr/>License</span></a></li><li><a href="#🔗-links"><span>🔗 <wbr/>Links</span></a></li><li><a href="#🆘-support"><span>🆘 <wbr/>Support</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="modules.html">@earth-app/collegedb</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
